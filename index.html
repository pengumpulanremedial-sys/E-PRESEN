<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMK Sehati Karawang - Sistem Absensi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- LucidAe Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js CDN for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Animasi Latar Belakang (Floating Blobs) */
        @keyframes float-blob {
            0% {
                transform: translate(0px, 0px) rotate(0deg) scale(1);
            }
            33% {
                transform: translate(20px, -25px) rotate(10deg) scale(1.05);
            }
            66% {
                transform: translate(-10px, 15px) rotate(-5deg) scale(0.95);
            }
            100% {
                transform: translate(0px, 0px) rotate(0deg) scale(1);
            }
        }

        /* Mengaktifkan backdrop blur untuk Glassmorphism */
        .glass-container {
            backdrop-filter: blur(12px); /* Blur lebih kuat */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4); /* Border lebih terang */
            background-color: rgba(255, 255, 255, 0.1); /* Lebih transparan (0.15 -> 0.1) */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Bayangan Biru/Ungu */
        }
        /* Mengaktifkan Glassmorphism untuk elemen transparan yang lebih kecil */
        .glass-element {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.15); /* Lebih transparan */
            color: #f3f4f6; /* Teks putih off-white */
            border-color: rgba(255, 255, 255, 0.3);
        }
        .glass-element::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Deep Blue/Purple Gradient Background matching the image */
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 40%, #a855f7 100%); 
            background-attachment: fixed;
            min-height: 100vh;
            transition: background 0.5s ease;
            color: #f3f4f6; /* Teks default ke Putih Off-White */
            position: relative;
            overflow-x: hidden; /* Mencegah scroll horizontal akibat animasi */
        }
        /* Mengatur ulang warna teks pada beberapa elemen penting agar lebih jelas (tidak abu-abu gelap) */
        #tab-content, .text-gray-700, .text-gray-600 {
            color: #f3f4f6; /* Default text inside glass container should be white */
        }
        /* Mengatur ulang warna teks pada beberapa elemen tertentu */
        .text-gray-500, .text-gray-400 {
            color: #d1d5db; /* Lebih terang dari sebelumnya */
        }
        
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #7c3aed;
            border-radius: 10px;
        }
        /* Ensure chart container maintains size */
        .chart-container {
            width: 100%;
        }
        /* Hide print-only elements in screen view */
        .print-only { 
            display: none !important; 
        }

        /* NEW: Floating Blobs (Gambar Bergerak) */
        .blob {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            opacity: 0.5;
            filter: blur(50px);
            z-index: -1;
            animation: float-blob 15s infinite alternate;
        }
        #blob-1 { top: 10%; left: 5%; animation-delay: 0s; background: rgba(56, 189, 248, 0.2); } /* Blue */
        #blob-2 { bottom: 5%; right: 15%; animation-delay: 5s; background: rgba(251, 191, 36, 0.2); } /* Yellow/Amber */
        #blob-3 { top: 50%; right: 5%; animation-delay: 10s; background: rgba(167, 139, 250, 0.2); } /* Violet */

        .modern-shadow {
            /* Dikelola oleh class glass-container */
        }
        .modern-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modern-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(124, 58, 237, 0.5); /* Shadow lebih intens */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- Adjust input fields inside glass element to be dark on dark background --- */
        .glass-container input[type="text"], 
        .glass-container input[type="password"], 
        .glass-container input[type="number"],
        .glass-container input[type="date"],
        .glass-container select,
        .glass-container textarea {
            background-color: rgba(255, 255, 255, 0.1);
            color: #f3f4f6; /* Warna teks yang jelas */
            border-color: rgba(255, 255, 255, 0.3);
        }
        .glass-container option {
            background-color: #4f46e5; /* Dark background for dropdown options */
            color: #f3f4f6;
        }
        
        /* CSS untuk menyembunyikan elemen non-cetak saat window.print() dipanggil (PERBAIKAN 1) */
        @media print {
            /* Sembunyikan elemen navigasi dan kontrol */
            header, nav, .flex.justify-end, .page:not(#dashboard-container), 
            h2, .bg-purple-50, .bg-indigo-50, #modal-message, #mini-popup, #dashboard-tabs, 
            .print-hidden, #recap-results > div:nth-child(1), #admin-recap-results > div:nth-child(1), 
            #teacher-recap-form, #admin-recap-form, #total-recap-form, #total-recap-message,
            #photo-dashboard-form, #photo-dashboard-message { /* <--- NEW: Hide photo dashboard filters */
                display: none !important;
            }
            
            /* Tampilkan header tabel di setiap halaman */
            thead {
                display: table-header-group;
            }
            
            /* Atur ulang margin dan padding untuk cetak penuh */
            body, main {
                margin: 0 !important;
                padding: 0 !important;
                min-height: auto !important;
                background: none !important; /* Hilangkan gradien saat cetak */
                color: #000 !important; /* Pastikan teks berwarna hitam saat cetak */
            }
            
            /* Pastikan konten utama yang dicetak menempati seluruh lebar kertas */
            #tab-content {
                box-shadow: none !important;
                border: none !important;
                overflow: visible !important;
                min-height: auto !important;
                width: 100% !important; 
                padding: 0 !important;
                background-color: transparent !important; /* Hilangkan transparansi/warna saat cetak */
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }
            /* Reset warna elemen tabel agar terlihat jelas saat dicetak */
            .glass-container table, .glass-container thead, .glass-container tbody, .glass-container tr, .glass-container td, .glass-container th {
                background-color: white !important;
                color: black !important;
                border-color: #ccc !important;
            }
            
            /* Tampilkan hasil rekap dan tabel */
            #recap-results, #admin-recap-results, #total-recap-results {
                display: block !important;
            }
            
            /* Reset overflow untuk mencetak semua baris tabel */
            .overflow-x-auto {
                overflow: visible !important;
            }
            
            /* Tampilkan header cetak */
            .print-only {
                display: block !important;
                margin-bottom: 20px !important;
                padding: 0 !important;
                border: none !important;
                color: #000; /* Pastikan teks berwarna hitam */
            }

            /* NEW: Photo Grid Print Settings (to print as list or large grid) */
            #photo-dashboard-results {
                display: block !important;
                padding: 10px;
                border: 1px solid #ccc;
            }
            #photo-grid-container {
                display: block !important;
                column-count: 2; /* Print in two columns */
                column-gap: 15px;
            }
            .glass-element.rounded-xl.overflow-hidden {
                display: inline-block;
                width: 100%;
                margin-bottom: 15px;
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                color: black !important;
                background-color: white !important;
            }
            .glass-element.rounded-xl.overflow-hidden * {
                color: black !important;
            }
            .glass-element.rounded-xl.overflow-hidden img {
                border: 1px solid #eee;
            }


            /* --- SKEMA LEBAR KOLOM BARU YANG LEBIH DINAMIS --- */
            /* Skema untuk Detail Harian */
            #recap-results table th:nth-child(1), 
            #admin-recap-results table th:nth-child(1) { width: 4%; } /* NO */
            
            #recap-results table th:nth-child(2), 
            #admin-recap-results table th:nth-child(2) { width: 14%; } /* NISN */
            
            #recap-results table th:nth-child(3), 
            #admin-recap-results table th:nth-child(3) { width: 28%; } /* NAMA SISWA (Paling Lebar) */
            
            #recap-results table th:nth-child(4), 
            #admin-recap-results table th:nth-child(4) { width: 16%; } /* KELAS/JURUSAN */
            
            #recap-results table th:nth-child(5), 
            #admin-recap-results table th:nth-child(5) { width: 16%; } /* TGL/WAKTU */
            
            #recap-results table th:nth-child(6), 
            #admin-recap-results table th:nth-child(6) { width: 8%; } /* STATUS */
            
            #recap-results table th:nth-child(7), 
            #admin-recap-results table th:nth-child(7) { width: 14%; } /* KETERANGAN */

            /* Skema untuk Rekap Total */
            #total-recap-results table th:nth-child(1) { width: 4%; } /* No */
            #total-recap-results table th:nth-child(2) { width: 12%; } /* NISN */
            #total-recap-results table th:nth-child(3) { width: 25%; } /* Nama Siswa */
            #total-recap-results table th:nth-child(4) { width: 13%; } /* Kelas/Jurusan */
            #total-recap-results table th:nth-child(5) { width: 11%; } /* Hadir */
            #total-recap-results table th:nth-child(6) { width: 11%; } /* Izin */
            #total-recap-results table th:nth-child(7) { width: 11%; } /* Sakit */
            #total-recap-results table th:nth-child(8) { width: 11%; } /* Alpha */
            
            /* --- END PERBAIKAN BUG OVERLAP CETAK --- */
        }
    </style>
</head>
<body class="antialiased">
    <!-- Animated Blobs (Gambar Bergerak) -->
    <div id="blob-1" class="blob"></div>
    <div id="blob-2" class="blob"></div>
    <div id="blob-3" class="blob"></div>

    <!-- Header (Selalu Tampil) -->
    <header class="bg-indigo-800 text-white shadow-2xl p-4 md:p-6 z-10 relative">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
            
            <!-- Logo dan Nama Sekolah (Diperbarui untuk Estetika Modern) -->
            <div class="flex items-center space-x-3 order-1 md:order-1 w-full md:w-auto">
                <img id="school-logo" class="h-10 w-auto rounded-full shadow-lg transition transform hover:scale-105" 
                    src="https://placehold.co/40x40/ffffff/indigo?text=S" 
                    onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/indigo?text=S';"
                    alt="Logo Sekolah">

                <h1 id="school-title-display" class="text-xl md:text-2xl font-extrabold tracking-tight cursor-default transition-colors duration-300 hover:text-indigo-200">
                    E-Absensi SMK Sehati Karawang
                </h1>
            </div>
            
            <!-- Tampilan Jam Lebih Besar dan Interaktif (ORDER-2 di Mobile dan Desktop) -->
            <div id="current-time" class="bg-indigo-700 py-2 px-6 rounded-xl shadow-lg transition duration-500 ease-in-out hover:bg-indigo-600 cursor-default text-center order-2 md:order-2">
                <!-- Waktu akan diisi oleh JavaScript -->
            </div>
            
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="container mx-auto p-4 md:p-8 relative z-0">

        <!-- Entry Page (Landing & Role Selection - Glassmorphism) -->
        <!-- Warna latar belakang diatur oleh CSS .glass-container, warna teks menjadi putih -->
        <div id="entry-page" class="page max-w-4xl mx-auto glass-container p-6 md:p-12 rounded-3xl transition-all duration-500 transform">
            
            <h2 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-4">Sistem Kehadiran Digital</h2>
            <p class="text-center text-white/90 mb-8 md:text-lg font-medium">
                Selamat datang di aplikasi e-absensi . Silakan pilih peran Anda untuk masuk ke dashboard.
                
            </p>
            
            <!-- Role Selection Tabs -->
            <div class="flex justify-center mb-10">
                <!-- Perubahan: Menggunakan glass-element untuk navbar transparansi yang lebih ringan -->
                <div id="role-selection" class="flex flex-wrap gap-3 p-2 glass-element rounded-xl modern-shadow max-w-lg w-full">
                    <!-- Buttons will be inserted by JS -->
                </div>
            </div>

            <!-- Login Form Area -->
            <div id="login-area" class="max-w-md mx-auto">
                <h3 id="login-title" class="text-2xl font-bold text-center mb-6 text-white">Pilih Peran Anda</h3>
                
                <form id="login-form" class="hidden space-y-5">
                    <div class="mb-3">
                        <label for="username" id="username-label" class="block text-sm font-medium text-white/90 mb-1">NISN / NIP</label>
                        <!-- Perubahan: Input fields menggunakan glass-element -->
                        <input type="text" id="username" name="username" required placeholder="Masukkan NISN atau NIP" class="w-full px-4 py-3 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 glass-element text-white placeholder-white/70">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-white/90 mb-1">Kata Sandi</label>
                        <!-- Perubahan: Input fields menggunakan glass-element -->
                        <input type="password" id="password" name="password" required placeholder="Masukkan Kata Sandi" class="w-full px-4 py-3 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 glass-element text-white placeholder-white/70">
                    </div>
                    <!-- Perubahan: Tombol Login menggunakan gradien biru/ungu -->
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-lg shadow-xl modern-hover">
                        Masuk
                    </button>
                </form>
                
            </div>
            
            <div id="login-message" class="mt-4 text-center text-red-400 font-semibold hidden"></div>
            <p class="text-xs text-white/70 text-center mt-6">
                *Perhatikan saat mengisi NISN/NIP telah sesaui, Jika ada kendala hub admin
            </p>
        </div>

        <!-- Dashboard Container (Dynamic Content) -->
        <div id="dashboard-container" class="page hidden fade-in">
            <div class="flex justify-end mb-4 print-hidden">
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-md modern-hover">
                    <span data-lucide="log-out" class="w-5 h-5 mr-2"></span> Keluar
                </button>
            </div>
            <h2 id="welcome-message" class="text-3xl font-bold text-white mb-6"></h2>

            <!-- Navigation Tabs -->
            <div id="dashboard-tabs" class="mb-6 border-b border-white/30">
                <nav class="flex space-x-2 custom-scrollbar overflow-x-auto" aria-label="Tabs">
                    <!-- Tabs will be inserted here by JS -->
                </nav>
            </div>

            <!-- Tab Content (Glassmorphism + Modern Shadow) -->
            <div id="tab-content" class="glass-container p-6 md:p-8 rounded-xl min-h-[500px]">
                <!-- Dynamic content based on user role and tab selection -->
            </div>
        </div>
    </main>

    <!-- Modal for Loading/Success Messages/Confirmation (Perbaikan 1) -->
    <div id="modal-message" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full transform scale-100 transition-transform duration-300">
            <div id="modal-icon" class="mb-4 text-indigo-600">
                <!-- Icon will be placed here -->
            </div>
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-body" class="text-gray-600"></p>
            <div id="modal-actions" class="mt-5 flex justify-end space-x-3 hidden">
                <!-- Buttons for confirmation/cancellation will be placed here by showConfirm -->
            </div>
        </div>
    </div>
    
    <!-- NEW: Mini Pop-up for Apply All feature (Perbaikan Pop-up) -->
    <div id="mini-popup" class="fixed bottom-4 right-4 z-40 p-4 bg-white/90 border border-indigo-100 rounded-xl shadow-2xl space-y-3 hidden transition-transform duration-300 transform translate-y-full max-w-sm">
        <p id="mini-popup-text" class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
            <span data-lucide="zap" class="w-5 h-5 text-indigo-500"></span>
            <span>Terapkan nilai/keterangan ini ke semua baris yang kosong?</span>
        </p>
        <div class="flex space-x-3">
            <button id="mini-popup-apply" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 rounded-lg shadow-md modern-hover">
                Terapkan Semua
            </button>
            <button id="mini-popup-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                Tidak
            </button>
        </div>
    </div>

    <!-- NEW: Modal for Add New Student (Perbaikan 2) -->
    <div id="add-student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="glass-container p-8 rounded-xl max-w-xl w-full transform scale-100 transition-transform duration-300">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span data-lucide="user-plus" class="w-6 h-6 mr-2"></span> Tambah Siswa Baru
            </h3>
            <form id="add-student-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="new-nisn" class="block text-sm font-medium text-white/90">NISN <span class="text-red-400">*</span></label>
                        <input type="text" id="new-nisn" name="nisn" required placeholder="Contoh: 0071234567" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                    </div>
                    <div>
                        <label for="new-nama" class="block text-sm font-medium text-white/90">Nama Lengkap <span class="text-red-400">*</span></label>
                        <input type="text" id="new-nama" name="nama" required placeholder="Nama Siswa" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                    </div>
                    <div>
                        <label for="new-kelas" class="block text-sm font-medium text-white/90">Kelas <span class="text-red-400">*</span></label>
                        <input type="text" id="new-kelas" name="kelas" required placeholder="Contoh: XII" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                    </div>
                    <div>
                        <label for="new-jurusan" class="block text-sm font-medium text-white/90">Jurusan <span class="text-red-400">*</span></label>
                        <select id="new-jurusan" name="jurusan" required class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                            <option value="" class="bg-indigo-700">-- Pilih Jurusan --</option>
                            <option value="RPL" class="bg-indigo-700">RPL (Rekayasa Perangkat Lunlunak)</option>
                            <option value="TKJ" class="bg-indigo-700">TKJ (Teknik Komputer Jaringan)</option>
                            <option value="TKR" class="bg-indigo-700">TKR (Teknik Kendaraan Ringan)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="new-email" class="block text-sm font-medium text-white/90">Email <span class="text-red-400">*</span></label>
                    <input type="text" id="new-email" name="email" required 
                                placeholder="email@sekolah.sch.id (Mengizinkan strip/hyphen)" 
                                pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                                class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                    <p class="text-xs text-white/70 mt-1">Pastikan email valid. Karakter strip (-) diizinkan di nama pengguna.</p>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-white/90">Password Awal <span class="text-red-400">*</span></label>
                    <input type="password" id="new-password" name="password" required placeholder="Password Awal" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 glass-element text-white placeholder-white/70">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddStudentModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                        Batal
                    </button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-xl transform hover:scale-[1.01] transition duration-200 modern-hover">
                        <span data-lucide="save" class="w-5 h-5 mr-2"></span> Simpan Data Siswa
                    </button>
                </div>
            </form>
        </div>
    </div>


<script>
    // ====================================================================
    // --- 1. CONFIGURATION & GLOBAL STATE ---
    // ====================================================================
    
    let APP_CONFIG = {
        SCHOOL_NAME: "E-Absensi SMK Sehati Karawang",
        LOGO_URL: "https://placehold.co/40x40/ffffff/indigo?text=S"
    };

    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1F72NOuTyeDYePeu5nLk_oLrvjecx-5iLCxj3cO57l1Y/edit";
    // GANTI URL INI DENGAN URL WEB APP DEPLOYMENT GOOGLE APPS SCRIPT ANDA!
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw17CezqtHpbmFMMPao-O0dgQJtDFLsvMve5rCPElcfAOmzimraj7ssHyWUqTjz_56i/exec"; 
    
    let currentUser = null;
    let currentTab = '';
    let currentRole = null; 
    let currentAttendanceRecord = null;
    let historyRecords = [];
    let allStudentsData = []; // Data mentah semua siswa untuk Admin Management
    let currentRecapData = [];
    let currentTotalRecapData = []; // NEW: Untuk menyimpan data rekap total
    let currentRecapFilters = {}; // NEW: Store current filters for printing/export

    // NEW: Global state untuk filter manajemen siswa
    let currentFilterTerm = '';
    let currentFilterKelas = '';
    let currentFilterJurusan = '';
    let currentFilteredStudentCount = 0;

    // --- NEW: Camera State ---
    let videoElement = null;
    let canvasElement = null;
    let photoDataInput = null;
    let photoPreview = null;
    let captureButton = null;
    let mediaStream = null;
    // --- END NEW: Camera State ---

    const CURRENT_DATE_WIB = new Date().toLocaleString('en-CA', { timeZone: 'Asia/Jakarta', year: 'numeric', month: '2-digit', day: '2-digit' }).split('/').join('-'); // YYYY-MM-DD
    
    let recapChartInstance = null;
    let comparisonChartInstanceClass = null; 
    let comparisonChartInstanceMajor = null; 
    let adminRecapChartInstance = null;

    // --- ROLE MAP ---
    const ROLE_MAP = {
        'siswa': { id: 'student', label: 'Siswa', icon: 'graduation-cap', placeholder: 'Masukkan NISN' },
        'guru': { id: 'teacher', label: 'Guru', icon: 'briefcase', placeholder: 'Masukkan NIP' },
        'admin': { id: 'admin', label: 'Admin', icon: 'shield-check', placeholder: 'Masukkan NIP' },
    };

    const TABS = {
        student: [
            { id: 'absensi', label: 'Isi Absensi', icon: 'check-circle' },
            { id: 'profil', label: 'Profil Saya', icon: 'user' },
        ],
        teacher: [
            { id: 'rekap-guru', label: 'Rekap Detail Harian', icon: 'file-text' }, // Existing Detail Recap
            { id: 'rekap-total', label: 'Rekap Total Absen', icon: 'bar-chart-2' }, // NEW Total Recap
            { id: 'dashboard-grafik', label: 'Dashboard Grafik', icon: 'bar-chart-3' }, // RENAMED
            { id: 'dashboard-foto', label: 'Dashboard Foto Absensi', icon: 'image' }, // <--- NEW TAB FOR PHOTOS
            { id: 'absensi-siswa', label: 'Absensi Manual Siswa', icon: 'calendar-check' }, 
            { id: 'penilaian', label: 'Input Penilaian', icon: 'file-plus' },
            { id: 'profil', label: 'Profil Saya', icon: 'user' },
        ],
        admin: [
            { id: 'rekap-admin', label: 'Rekap Detail Global', icon: 'database' },
            { id: 'rekap-total', label: 'Rekap Total Absen', icon: 'bar-chart-2' }, // NEW Total Recap
            { id: 'konfigurasi', label: 'Konfigurasi Aplikasi', icon: 'settings' }, 
            { id: 'manajemen', label: 'Manajemen Data Siswa', icon: 'users' }, 
        ]
    };


    // ====================================================================
    // --- 2. UTILITY & MODAL FUNCTIONS --- (Perbaikan 1: Modal interaktif)
    // ====================================================================

    function getTimeString(dateObj) {
        if (isNaN(dateObj)) return 'Waktu Invalid';
        
        const wibTime = dateObj.toLocaleTimeString('sv-SE', {
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Jakarta'
        });
        
        const parts = wibTime.match(/\d{2}/g);
        if (parts && parts.length === 3) {
            return `${parts[0]}:${parts[1]}:${parts[2]}`;
        }
        
        const hours = String(dateObj.getHours()).padStart(2, '0');
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const seconds = String(dateObj.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    function updateHeaderDisplay() {
        const titleEl = document.getElementById('school-title-display');
        const logoEl = document.getElementById('school-logo');

        if (titleEl) titleEl.innerText = APP_CONFIG.SCHOOL_NAME;
        if (logoEl) logoEl.src = APP_CONFIG.LOGO_URL;
        document.title = APP_CONFIG.SCHOOL_NAME;
    }

    function updateTime() {
        const now = new Date();
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' };
        
        const formattedDate = now.toLocaleString('id-ID', dateOptions);
        const formattedTime = getTimeString(now);

        document.getElementById('current-time').innerHTML = `
            <div class="min-w-[280px] text-center">
                <div class="flex items-baseline justify-center space-x-2">
                    <span class="block text-4xl lg:text-5xl font-extrabold leading-none min-w-[160px] text-right">${formattedTime}</span>
                    <span class="block text-base md:text-lg font-bold opacity-90">WIB</span>
                </div>
                <span class="block text-base md:text-lg font-medium opacity-80">${formattedDate}</span>
            </div>
        `;
    }

    function formatDateTime(dateString, timeString, isDateOnly = false) {
        if (isDateOnly) return dateString;
        if (/^\d{2}:\d{2}:\d{2}$/.test(timeString)) return timeString;
        const timePartMatch = timeString.match(/(\d{2}:\d{2}:\d{2})/);
        if (timePartMatch) return timePartMatch[0];
        return 'Waktu Tidak Valid';
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.add('hidden');
        });
        document.getElementById(pageId).classList.remove('hidden');
        document.getElementById(pageId).classList.add('fade-in'); // Trigger fade-in animation
    }

    function hideModal() {
        document.getElementById('modal-message').classList.add('hidden');
    }
    
    function showModal(title, body, type, duration = 0, customIcon = null) {
        const modal = document.getElementById('modal-message');
        const iconDiv = document.getElementById('modal-icon');
        const titleEl = document.getElementById('modal-title');
        const bodyEl = document.getElementById('modal-body');
        const actionsEl = document.getElementById('modal-actions');
        
        hideMiniPopup(); 
        actionsEl.innerHTML = '';
        actionsEl.classList.add('hidden'); 

        let iconHtml = '';
        let colorClass = 'text-indigo-600';

        if (type === 'loading') {
            iconHtml = `<div class="animate-spin"><span data-lucide="loader-circle" class="w-10 h-10 mx-auto"></span></div>`;
            colorClass = 'text-indigo-600';
        } else if (type === 'success') {
            iconHtml = `<span data-lucide="${customIcon || 'check-circle'}" class="w-10 h-10 mx-auto text-emerald-500"></span>`;
            colorClass = 'text-emerald-500';
        } else if (type === 'error') {
            iconHtml = `<span data-lucide="${customIcon || 'x-circle'}" class="w-10 h-10 mx-auto text-red-500"></span>`;
            colorClass = 'text-red-500';
        } else if (type === 'info') {
             iconHtml = `<span data-lucide="${customIcon || 'info'}" class="w-10 h-10 mx-auto text-blue-500"></span>`;
            colorClass = 'text-blue-500';
        }

        iconDiv.innerHTML = iconHtml;
        titleEl.innerText = title;
        titleEl.className = `text-xl font-bold mb-3 ${colorClass}`;
        bodyEl.innerText = body;

        modal.classList.remove('hidden');
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        if (duration > 0) {
            setTimeout(() => {
                modal.classList.add('hidden');
            }, duration);
        }
    }
    
    function showConfirm(title, body, onConfirm) {
        const modal = document.getElementById('modal-message');
        const iconDiv = document.getElementById('modal-icon');
        const titleEl = document.getElementById('modal-title');
        const bodyEl = document.getElementById('modal-body');
        const actionsEl = document.getElementById('modal-actions');
        
        hideMiniPopup();
        
        // Setup content
        iconDiv.innerHTML = `<span data-lucide="alert-triangle" class="w-10 h-10 mx-auto text-amber-500"></span>`;
        titleEl.innerText = title;
        titleEl.className = `text-xl font-bold mb-3 text-amber-600`;
        bodyEl.innerText = body;
        
        // Setup buttons
        actionsEl.innerHTML = `
            <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">Batal</button>
            <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-xl transition duration-150">Ya, Hapus/Lanjut</button>
        `;
        actionsEl.classList.remove('hidden');

        // Add event listeners
        document.getElementById('confirm-cancel').onclick = hideModal;
        document.getElementById('confirm-ok').onclick = () => {
            hideModal();
            onConfirm();
        };

        modal.classList.remove('hidden');
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }


    // NEW: Fungsi untuk menampilkan/menyembunyikan modal tambah siswa
    function openAddStudentModal() {
        document.getElementById('add-student-modal').classList.remove('hidden');
        document.getElementById('add-student-form').reset();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeAddStudentModal() {
        document.getElementById('add-student-modal').classList.add('hidden');
    }

    function showMiniPopup(type, targetInput, value) {
        const popup = document.getElementById('mini-popup');
        const textEl = document.getElementById('mini-popup-text');
        const applyBtn = document.getElementById('mini-popup-apply');
        
        const isScore = (type === 'score');
        const isHadir = (type === 'hadir');
        const label = isScore ? `Nilai ${value}` : (isHadir ? `Status 'Hadir'` : `Keterangan '${value}'`);
        
        textEl.innerHTML = `<span data-lucide="zap" class="w-5 h-5 text-indigo-500"></span> <span>Terapkan nilai/keterangan ini ke semua baris yang kosong?</span>`;
        applyBtn.classList.toggle('bg-indigo-600', !isScore);
        applyBtn.classList.toggle('hover:bg-indigo-700', !isScore);
        applyBtn.classList.toggle('bg-green-600', isScore);
        applyBtn.classList.toggle('hover:bg-green-700', isScore);

        applyBtn.onclick = () => applyMassChange(type, targetInput, value);
        document.getElementById('mini-popup-cancel').onclick = hideMiniPopup;

        popup.classList.remove('hidden');
        popup.classList.remove('translate-y-full');
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function hideMiniPopup() {
        const popup = document.getElementById('mini-popup');
        popup.classList.add('translate-y-full');
        setTimeout(() => {
            popup.classList.add('hidden');
        }, 300);
    }

    function applyMassChange(type, sourceInput, value) {
        hideMiniPopup();
        
        const targetContainer = sourceInput.closest('tbody');
        if (!targetContainer) return;
        
        let targetInputs;
        
        if (type === 'keterangan') {
            targetInputs = targetContainer.querySelectorAll('textarea[name^="keterangan_"]:not([disabled])');
        } else if (type === 'score') {
            targetInputs = targetContainer.querySelectorAll('input[type="number"][name^="score_"]');
        } else if (type === 'hadir') {
            targetInputs = targetContainer.querySelectorAll('select[name^="status_"]');
        }
        
        if (targetInputs) {
            targetInputs.forEach(input => {
                if (type === 'keterangan') {
                    if (input.value.trim() === '') {
                        input.value = value;
                    }
                } else if (type === 'score') {
                    if (input.value === '' || parseInt(input.value) === 0) {
                        input.value = value;
                    }
                } else if (type === 'hadir') {
                    if (input.value !== 'Hadir') {
                        input.value = 'Hadir';
                        input.dispatchEvent(new Event('change'));
                    }
                }
            });
            showModal('Berhasil Diterapkan', `${targetInputs.length} baris telah diisi dengan nilai/keterangan/status yang sama.`, 'success', 2000);
        }
    }

    // --- ROLE SELECTION RENDERING (DIPINDAHKAN KE SINI) ---

    function renderRoleSelection() {
        const roleContainer = document.getElementById('role-selection');
        roleContainer.innerHTML = '';
        
        Object.keys(ROLE_MAP).forEach(key => {
            const role = ROLE_MAP[key];
            const button = document.createElement('button');
            button.id = `role-btn-${role.id}`;
            // Added modern-hover class
            button.className = `flex-1 flex items-center justify-center space-x-2 px-6 py-3 m-1 rounded-lg text-sm font-semibold transition-all duration-200 focus:outline-none modern-hover`;
            button.innerHTML = `<span data-lucide="${role.icon}" class="w-5 h-5"></span><span>${role.label}</span>`;
            button.onclick = () => selectRole(role.id); // <-- PANGGILAN selectRole
            roleContainer.appendChild(button);
        });
        
        Object.keys(ROLE_MAP).forEach(key => {
            const role = ROLE_MAP[key];
            // Mengubah warna tombol agar kontras dengan latar belakang Glassmorphism
            const btn = document.getElementById(`role-btn-${role.id}`);
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg'); // Remove previous active style
            btn.classList.add('bg-white/20', 'text-white', 'hover:bg-white/50', 'hover:text-white');
        });

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }


    // ====================================================================
    // --- 3. GAS COMMUNICATION FUNCTIONS --- (FIX BUG 1: Tambahkan Retry Logic)
    // ====================================================================

    async function fetchData(endpointUrl) {
        if (WEB_APP_URL === "") {
            console.error("WEB_APP_URL belum diatur.");
            showModal('Error Konfigurasi', 'WEB_APP_URL harus diisi. Harap ganti placeholder "" dengan URL Web App Anda yang berakhiran /exec.', 'error', 5000);
            return null;
        }
        
        const MAX_RETRIES = 3;
        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
            try {
                const response = await fetch(endpointUrl, {
                    method: 'GET',
                    mode: 'cors' 
                });
                
                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    // This error indicates a server crash or a redirection, often due to an invalid SPREADSHEET_ID in Apps Script.
                    throw new Error('Apps Script Server Crash: Server mengembalikan kode HTML (bukan JSON/Text).');
                }

                try {
                    const result = JSON.parse(text);
                    if (result.status === 'error' && result.message.includes('Aksi tidak dikenali.')) {
                        const specificError = `Error: ${result.message} Anda perlu melakukan REDEPLOY ULANG Google Apps Script sebagai VERSI BARU setelah menambahkan kode fungsi terkait ke file Code.gs.`;
                        throw new Error(specificError);
                    }
                    return result; // Success, break out of loop
                } catch (e) {
                    if (text.includes('Absensi berhasil disimpan.') || text.includes('Pembaruan nilai berhasil.')) {
                        return { status: 'success', message: text };
                    }
                    if (text.startsWith('Error:')) {
                        throw new Error(text);
                    }
                    throw new Error('Respon server tidak terduga, bukan JSON: ' + text);
                }
            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    console.warn(`Fetch GET attempt ${attempt + 1} failed. Retrying in ${2 ** attempt}s...`, error);
                    // Implement exponential backoff
                    await new Promise(resolve => setTimeout(resolve, (2 ** attempt) * 1000));
                } else {
                    // Final attempt failed
                    console.error('Fetch/CORS Error:', error);
                    const errorMessage = `Gagal terhubung ke server Apps Script (Network/CORS Error) setelah ${MAX_RETRIES} kali percobaan. PASTIKAN: 1) URL /exec sudah benar, 2) Akses "Anyone" saat di-deploy, 3) Redeploy Versi Baru. Error Terakhir: ${error.message.substring(0, 100)}...`;
                    showModal('Koneksi Gagal (Retry Failed)', errorMessage, 'error', 7000);
                    return { status: 'error', message: errorMessage };
                }
            }
        }
    }


    async function postData(payload) {
        if (WEB_APP_URL === "") {
            showModal('Error Konfigurasi', 'WEB_APP_URL harus diisi. Harap ganti placeholder "" dengan URL Web App Anda yang berakhiran /exec.', 'error', 5000);
            return { status: 'error', message: 'WEB_APP_URL belum diatur.' };
        }
        
        const MAX_RETRIES = 3;
        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST', mode: 'cors', body: payload,
                });

                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    throw new Error('Apps Script Server Crash: Server mengembalikan kode HTML (bukan JSON/Text).');
                }

                try {
                    const result = JSON.parse(text);
                    return result; // Success, break out of loop
                } catch (e) {
                    if (text.includes('Absensi berhasil disimpan.') || text.includes('Pembaruan nilai berhasil.') || text.includes('Data siswa baru berhasil ditambahkan.') || text.includes('siswa telah dihapus berdasarkan filter') || text.includes('konfigurasi berhasil disimpan.')) {
                        return { status: 'success', message: text };
                    }
                    if (text.startsWith('Error:')) {
                        throw new Error(text);
                    }
                    throw new Error('Respon POST tidak terduga, bukan JSON: ' + text);
                }
            } catch (error) {
                 if (attempt < MAX_RETRIES - 1) {
                    console.warn(`Fetch POST attempt ${attempt + 1} failed. Retrying in ${2 ** attempt}s...`, error);
                    // Implement exponential backoff
                    await new Promise(resolve => setTimeout(resolve, (2 ** attempt) * 1000));
                } else {
                    // Final attempt failed
                    console.error('Fetch/CORS Error:', error);
                    const errorMessage = `Gagal mengirim data ke server Apps Script (Network/CORS Error) setelah ${MAX_RETRIES} kali percobaan. PASTIKAN: 1) URL /exec sudah benar, 2) Akses "Anyone" saat di-deploy, 3) Redeploy Versi Baru. Error Terakhir: ${error.message.substring(0, 100)}...`;
                    showModal('Koneksi Gagal (Retry Failed)', errorMessage, 'error', 7000);
                    return { status: 'error', message: errorMessage };
                }
            }
        }
    }

    // ====================================================================
    // --- CORE STUDENT DATA FETCH HANDLERS (Moved to ensure definition before call) ---
    // ====================================================================

    async function checkStudentAttendanceStatus() {
        currentAttendanceRecord = null;
        if (currentUser.role !== 'student') return;

        const url = `${WEB_APP_URL}?action=getStudentStatus&nisn=${currentUser.nisn}&date=${CURRENT_DATE_WIB}`;
        const result = await fetchData(url);
        
        if (result && result.status === 'success') {
            currentAttendanceRecord = result.record;
        }
    }

    async function getStudentHistory() {
        historyRecords = [];
        if (currentUser.role !== 'student') return;

        const url = `${WEB_APP_URL}?action=getStudentHistory&nisn=${currentUser.nisn}`;
        const result = await fetchData(url);

        if (result && result.status === 'success') {
            historyRecords = result.records;
        } else {
             if (result && result.message && result.message.includes('Aksi tidak dikenali.')) {
                 console.error(`Gagal memuat riwayat absensi: Aksi "getStudentHistory" tidak dikenali di Apps Script.`);
                 showModal('Konfigurasi Server', 'Error: Aksi "getStudentHistory" tidak dikenali. Harap update Code.gs dan Redeploy Apps Script sebagai Versi Baru!', 'error', 7000);
             } else {
                 console.error(`Gagal memuat riwayat absensi: ${result ? result.message : 'Unknown Error'}`);
             }
        }
    }


    // ====================================================================
    // --- 4. CORE LOGIC (LOGIN, NAVIGATION, STATE) --- (Updated)
    // ====================================================================

    function renderDashboardTabs() {
        const tabsContainer = document.querySelector('#dashboard-tabs nav');
        tabsContainer.innerHTML = '';

        TABS[currentUser.role].forEach(tab => {
            const button = document.createElement('button');
            button.id = `tab-${tab.id}`;
            // NEW: Warna tab disesuaikan agar kontras elegan
            button.className = `flex items-center px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-150 text-white/70 hover:text-white hover:bg-white/10`;
            button.innerHTML = `<span data-lucide="${tab.icon}" class="w-4 h-4 mr-2"></span>${tab.label}`;
            button.onclick = () => selectTab(tab.id);
            tabsContainer.appendChild(button);
        });

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    async function renderTabContent(tabId) {
        const contentDiv = document.getElementById('tab-content');
        // PERBAIKAN: Kontras dan Ukuran Loading Message
        contentDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-10">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat data...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        hideMiniPopup();

        if (tabId === 'absensi') {
            await Promise.all([checkStudentAttendanceStatus(), getStudentHistory()]);
        }
        
        contentDiv.innerHTML = '';

        if (recapChartInstance) { recapChartInstance.destroy(); recapChartInstance = null; }
        if (adminRecapChartInstance) { adminRecapChartInstance.destroy(); adminRecapChartInstance = null; }
        // FIX: Ensure both comparison chart instances are destroyed
        if (comparisonChartInstanceClass) { comparisonChartInstanceClass.destroy(); comparisonChartInstanceClass = null; } 
        if (comparisonChartInstanceMajor) { comparisonChartInstanceMajor.destroy(); comparisonChartInstanceMajor = null; }

        if (tabId !== 'rekap-guru' && tabId !== 'rekap-admin') {
            currentRecapData = [];
        }
        
        if (tabId !== 'rekap-total') {
            currentTotalRecapData = []; // Clear total recap state on tab change
        }

        currentRecapFilters = {}; // Clear print filters on tab change


        switch (tabId) {
            case 'absensi':
                contentDiv.innerHTML = renderStudentAttendanceForm();
                contentDiv.insertAdjacentHTML('beforeend', renderStudentAttendanceHistory());
                setupAttendanceFormListeners();
                break;
            case 'profil':
                contentDiv.innerHTML = renderProfilePage();
                break;
            case 'rekap-guru':
                contentDiv.innerHTML = renderTeacherRecap();
                setupTeacherRecapListeners();
                break;
            // NEW CASE: Rekap Total Absen
            case 'rekap-total':
                contentDiv.innerHTML = renderTeacherTotalRecap();
                setupTeacherTotalRecapListeners();
                break;
            case 'dashboard-grafik': // RENAMED
                contentDiv.innerHTML = renderTeacherComparison();
                setupTeacherComparisonListeners(); 
                break;
            // NEW CASE: Dashboard Foto Absensi
            case 'dashboard-foto': 
                contentDiv.innerHTML = renderTeacherPhotoDashboard();
                setupTeacherPhotoDashboardListeners();
                break;
            case 'absensi-siswa':
                contentDiv.innerHTML = renderTeacherStudentAttendance();
                setupTeacherStudentAttendanceListeners(); 
                break;
            case 'penilaian':
                contentDiv.innerHTML = renderTeacherAssessment();
                setupTeacherAssessmentListeners();
                break;
            case 'rekap-admin':
                contentDiv.innerHTML = renderAdminGlobalRecap();
                setupAdminRecapListeners();
                break;
            case 'konfigurasi':
                contentDiv.innerHTML = renderAdminConfiguration();
                setupAdminConfigurationListeners(); // NEW HANDLER
                break;
            case 'manajemen':
                contentDiv.innerHTML = renderAdminManagement();
                setupAdminManagementListeners();
                break;
            default:
                contentDiv.innerHTML = `<p class="text-center text-gray-500 py-10">Pilih menu di atas.</p>`;
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }


    function selectRole(roleId) {
        currentRole = roleId;

        if (roleId) {
            const roleInfo = Object.values(ROLE_MAP).find(r => r.id === roleId);

            Object.keys(ROLE_MAP).forEach(key => {
                const role = ROLE_MAP[key];
                // NEW: Menggunakan warna transparan untuk tombol yang tidak aktif
                const btn = document.getElementById(`role-btn-${role.id}`);
                btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                btn.classList.add('bg-white/20', 'text-white', 'hover:bg-white/40');
            });
            const selectedBtn = document.getElementById(`role-btn-${roleId}`);
            
            if (selectedBtn) {
                // NEW: Menggunakan gradien untuk tombol yang aktif
                selectedBtn.classList.remove('bg-white/20', 'text-white', 'hover:bg-white/40');
                selectedBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-lg', 'shadow-blue-500/50');

                const loginForm = document.getElementById('login-form');
                const loginTitle = document.getElementById('login-title');
                const usernameLabel = document.getElementById('username-label');
                const usernameInput = document.getElementById('username');
                
                loginTitle.innerText = `Masuk sebagai ${roleInfo.label}`;
                usernameLabel.innerHTML = `${roleInfo.label === 'Siswa' ? 'NISN' : 'NIP'} <span class="text-sm text-white/70">(${roleInfo.label})</span>`;
                usernameInput.placeholder = roleInfo.placeholder;
                loginForm.classList.remove('hidden');
                document.getElementById('login-message').classList.add('hidden');
                usernameInput.focus();
            }
        }
    }

    function loadAppState() {
        const savedState = localStorage.getItem('absensiAppState');
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                
                // PERBAIKAN BUG REFRESH: Hapus pengecekan tanggal harian yang agresif.
                // Sesi akan dipertahankan selama user belum logout.
                if (state.user && state.role && state.tab) {
                    currentUser = state.user;
                    currentRole = state.role;
                    initializeDashboard(state.tab);
                    return true;
                } else {
                    localStorage.removeItem('absensiAppState');
                }
            } catch (e) {
                console.error("Gagal memuat status aplikasi dari localStorage:", e);
                localStorage.removeItem('absensiAppState');
            }
        }
        return false;
    }

    function saveAppState() {
        if (currentUser && currentUser.role && currentTab) {
            localStorage.setItem('absensiAppState', JSON.stringify({
                role: currentUser.role,
                tab: currentTab,
                lastLoginDate: new Date().toISOString().split('T')[0], // Simpan tanggal login (untuk referensi, tidak wajib untuk sesi)
                user: {
                    nisn: currentUser.nisn, nip: currentUser.nip, nama: currentUser.nama,
                    kelas: currentUser.kelas, jurusan: currentUser.jurusan,
                    kelasAjar: currentUser.kelasAjar, jurusanAjar: currentUser.jurusanAjar,
                    email: currentUser.email
                }
            }));
        } else {
            localStorage.removeItem('absensiAppState');
        }
    }

    function initializeDashboard(initialTab = null) {
        showPage('dashboard-container');
        document.getElementById('welcome-message').innerText = `Selamat Datang, ${currentUser.nama}!`;
        renderDashboardTabs();
        
        let tabToOpen = initialTab;
        if (!tabToOpen) {
            if (currentUser.role === 'student') tabToOpen = 'absensi';
            else if (currentUser.role === 'teacher') tabToOpen = 'rekap-guru';
            else if (currentUser.role === 'admin') tabToOpen = 'rekap-admin';
        }
        selectTab(tabToOpen);
    }

    function logout() {
        stopCamera(); // Stop camera on logout
        if (recapChartInstance) { recapChartInstance.destroy(); recapChartInstance = null; }
        if (adminRecapChartInstance) { adminRecapChartInstance.destroy(); adminRecapChartInstance = null; }
        if (comparisonChartInstanceClass) { comparisonChartInstanceClass.destroy(); comparisonChartInstanceClass = null; }
        if (comparisonChartInstanceMajor) { comparisonChartInstanceMajor.destroy(); comparisonChartInstanceMajor = null; }

        allStudentsData = []; currentRecapData = []; currentTotalRecapData = [];
        currentUser = null; currentRole = null; currentTab = '';
        saveAppState(); // Removes state

        showPage('entry-page');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('login-message').classList.add('hidden');
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('login-title').innerText = 'Pilih Peran Anda';

        Object.keys(ROLE_MAP).forEach(key => {
            const role = ROLE_MAP[key];
            const btn = document.getElementById(`role-btn-${role.id}`);
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
            btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-indigo-50', 'hover:text-indigo-700');
        });
    }

    function selectTab(tabId) {
        stopCamera(); // Stop camera when navigating away from absensi tab

        currentTab = tabId;
        saveAppState();

        document.querySelectorAll('#dashboard-tabs button').forEach(btn => {
            // NEW: Warna tab disesuaikan agar kontras elegan (transparan/putih)
            btn.classList.remove('text-indigo-700', 'border-b-4', 'border-indigo-700', 'bg-indigo-50');
            btn.classList.add('text-white/70', 'hover:text-white', 'hover:bg-white/10');
        });

        const selectedBtn = document.getElementById(`tab-${tabId}`);
        if (selectedBtn) {
            // NEW: Warna tab aktif
            selectedBtn.classList.remove('text-white/70', 'hover:text-white', 'hover:bg-white/10');
            selectedBtn.classList.add('text-white', 'border-b-4', 'border-white', 'bg-white/20');
        }

        renderTabContent(tabId);
    }
    // ====================================================================
    // --- 5. CHARTING & RECAP FUNCTIONS ---
    // ====================================================================

    function renderRecapSummary(id, summary) {
        const total = summary['Total'] || 0;
        const totalTidakHadir = (summary['Izin'] || 0) + (summary['Sakit'] || 0) + (summary['Alpha'] || 0);

        const cardData = [
            // NEW: Mengubah skema warna kartu dan teks menjadi lebih elegan di atas latar gelap
            { label: "Total Siswa", value: total, icon: "users", color: "text-blue-300", bg: "bg-white/10", iconColor: "text-blue-300" },
            { label: "Total Hadir", value: summary['Hadir'] || 0, icon: "check-circle", color: "text-emerald-300", bg: "bg-white/10", iconColor: "text-emerald-300" },
            { label: "Total Tidak Hadir", value: totalTidakHadir, icon: "x-circle", color: "text-red-300", bg: "bg-white/10", iconColor: "text-red-300" },
            { label: "Izin/Sakit", value: (summary['Izin'] || 0) + (summary['Sakit'] || 0), icon: "user-x", color: "text-amber-300", bg: "bg-white/10", iconColor: "text-amber-300" },
            // PERBAIKAN: Warna Alpha menjadi merah menyala
            { label: "Alpha", value: summary['Alpha'] || 0, icon: "skull", color: "text-rose-400 font-extrabold", bg: "bg-white/10", iconColor: "text-rose-400" }, 
        ];

        const html = cardData.map(card => `
            <div class="${card.bg} p-4 rounded-xl flex items-center justify-between transition duration-200 modern-hover shadow-lg">
                <div>
                    <p class="text-sm font-medium text-white/70">${card.label}</p>
                    <p class="text-2xl font-bold ${card.color}">${card.value}</p>
                </div>
                <span data-lucide="${card.icon}" class="${card.iconColor} w-8 h-8 opacity-70"></span>
            </div>
        `).join('');

        document.getElementById(id).innerHTML = html;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderAttendanceChart(canvasId, summaryData, isTeacherRecap) {
        // Mendapatkan konteks 2D untuk membuat gradien
        const ctx = document.getElementById(canvasId).getContext('2d'); 
        let currentInstance = (canvasId === 'recap-chart') ? recapChartInstance : adminRecapChartInstance;
        if (currentInstance) currentInstance.destroy();

        // --- NEW: Custom Neon Gradient Colors matching image theme ---
        const createNeonGradient = (colorStart, colorEnd) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        };

        const gradientHadir = createNeonGradient('#10b981', '#059669'); // Green
        const gradientIzin = createNeonGradient('#f59e0b', '#d97706'); // Amber
        const gradientSakit = createNeonGradient('#ef4444', '#dc2626'); // Red
        const gradientAlpha = createNeonGradient('#f43f5e', '#be123c'); // PERBAIKAN: Merah Rose (Neon Red/Scarlet)
        
        // --- END Gradient Logic ---

        const chartData = {
            labels: ['Hadir', 'Izin', 'Sakit', 'Alpha'],
            datasets: [{
                label: 'Jumlah Siswa',
                data: [
                    summaryData['Hadir'] || 0, summaryData['Izin'] || 0,
                    summaryData['Sakit'] || 0, summaryData['Alpha'] || 0
                ],
                backgroundColor: [gradientHadir, gradientIzin, gradientSakit, gradientAlpha],
                // NEW: Menggunakan warna neon/terang untuk border
                borderColor: ['#34d399', '#fcd34d', '#f87171', '#f43f5e'], // Boundary ke Merah Rose
                borderWidth: 3, 
                borderRadius: 15, 
                borderSkipped: false,
                hoverBackgroundColor: ['#34d399', '#fcd34d', '#f87171', '#f43f5e'],
            }]
        };

        const newChart = new Chart(ctx.canvas, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { 
                        callbacks: { label: (c) => `${c.label}: ${c.parsed.y} Siswa` },
                        backgroundColor: 'rgba(30, 41, 59, 0.9)', // Dark background for tooltip
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        boxPadding: 8,
                        usePointStyle: true,
                        // NEW: Custom hover effect
                        caretPadding: 10,
                    } 
                },
                layout: {
                    padding: { top: 10, bottom: 10 }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1, 
                            callback: (v) => Number.isInteger(v) ? v : null, 
                            font: { size: 13 },
                            color: '#e5e7eb' // Light ticks color
                        }, 
                        grid: { 
                            drawBorder: false, 
                            color: 'rgba(255, 255, 255, 0.15)' // Subtle grid lines
                        } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { font: { size: 13, weight: 'bold' }, color: '#e5e7eb' } // Light ticks color
                    }
                }
            },
        });

        if (canvasId === 'recap-chart') recapChartInstance = newChart;
        else if (canvasId === 'admin-recap-chart') adminRecapChartInstance = newChart;
    }

    function renderDemographicChart(canvasId, data, chartTitle) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (comparisonChartInstanceClass) comparisonChartInstanceClass.destroy();
        comparisonChartInstanceClass = null;

        // --- NEW: Gradient for Demographics (Neon Blue) ---
        const gradientDemo = ctx.createLinearGradient(0, 0, 0, 400);
        gradientDemo.addColorStop(0, '#38bdf8'); // Sky Blue
        gradientDemo.addColorStop(1, '#1e40af'); // Dark Blue

        const labels = data.map(d => d.label);
        const values = data.map(d => d.value);

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'Jumlah Total Siswa',
                data: values,
                backgroundColor: gradientDemo, // Use gradient
                borderColor: '#38bdf8',
                borderWidth: 3, 
                borderRadius: 15, 
                borderSkipped: false,
            }]
        };

        const newChart = new Chart(ctx.canvas, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }, 
                    title: { display: true, text: chartTitle, font: { size: 18, weight: 'bold', family: 'Inter' }, color: '#fff' }, // Light color for title
                    tooltip: { 
                        callbacks: { label: (c) => `Total Siswa: ${c.parsed.y}` },
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#38bdf8',
                        borderWidth: 1,
                        boxPadding: 8,
                        usePointStyle: true,
                        // NEW: Custom hover effect
                        caretPadding: 10,
                    } 
                },
                layout: {
                    padding: { top: 10, bottom: 10 }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Jumlah Siswa', font: { size: 14 }, color: '#e5e7eb' },
                        ticks: { stepSize: 1, callback: (v) => Number.isInteger(v) ? v : null, font: { size: 13 }, color: '#e5e7eb' }, 
                        grid: { drawBorder: false, color: 'rgba(255, 255, 255, 0.15)' } 
                    },
                    x: { 
                        title: { display: true, text: 'Kelas/Jurusan', font: { size: 14 }, color: '#e5e7eb' },
                        grid: { display: false },
                        ticks: { font: { size: 13, weight: 'bold' }, color: '#e5e7eb' }
                    }
                }
            },
        });

        comparisonChartInstanceClass = newChart;
    }
    
    // NEW: Render chart untuk Kehadiran (Perbaikan 1)
    function renderAttendanceComparisonChart(canvasId, data, filterType) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        // FIX: Ensure previous instance is destroyed
        if (comparisonChartInstanceMajor) comparisonChartInstanceMajor.destroy();
        comparisonChartInstanceMajor = null;

        // --- NEW: Dynamic Neon Gradient Colors for Stacked Bars ---
        const createNeonGradient = (colorStart, colorEnd) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        };

        const colors = {
            // Using brighter colors for visibility on dark glassmorphism
            'Hadir': { bg: createNeonGradient('#34d399', '#059669'), border: '#34d399' },
            'Izin': { bg: createNeonGradient('#fcd34d', '#d97706'), border: '#fcd34d' },
            'Sakit': { bg: createNeonGradient('#f87171', '#dc2626'), border: '#f87171' },
            'Alpha': { bg: createNeonGradient('#f43f5e', '#be123c'), border: '#f43f5e' } // PERBAIKAN: Merah Rose (Neon Red/Scarlet)
        };
        // --- END Gradient Logic ---

        const labels = Object.keys(data); // Nama Kelas/Jurusan (or composite key)
        const statuses = ['Hadir', 'Izin', 'Sakit', 'Alpha'];

        const datasets = statuses.map(status => ({
            label: status,
            data: labels.map(label => data[label][status] || 0),
            backgroundColor: colors[status].bg,
            borderColor: colors[status].border,
            borderWidth: 1,
            stack: 'Stack 0', // Untuk membuat stacked bar
            borderRadius: 5, // Added rounding
            borderSkipped: false,
        }));
        
        // Dynamic title based on filterType
        let chartTitleAttend;
        if (filterType === 'class') {
            chartTitleAttend = 'Persentase Kehadiran per Kelas';
        } else if (filterType === 'major') {
            const gradeLevel = document.getElementById('comparison-grade-level').value;
            chartTitleAttend = `Persentase Kehadiran per Jurusan & Tingkat (${gradeLevel || 'Semua Tingkat'})`;
        }


        const newChart = new Chart(ctx.canvas, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: chartTitleAttend, font: { size: 18, weight: 'bold', family: 'Inter' }, color: '#fff' }, // UPDATED: uses local chartTitleAttend
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 14 }, color: '#e5e7eb' } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        boxPadding: 8,
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`, // Display percentage with 2 decimals
                            title: (context) => `${context[0].label} (Total: ${data[context[0].label].TotalRecords} records)`
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: true, 
                        grid: { display: false },
                        ticks: { font: { size: 13, weight: 'bold' }, color: '#e5e7eb' } 
                    },
                    y: { 
                        stacked: true, 
                        beginAtZero: true, 
                        max: 100, 
                        title: { display: true, text: 'Persentase Kehadiran (%)', font: { size: 14 }, color: '#e5e7eb' },
                        ticks: { 
                            callback: function(value) { return value + '%'; }, // Add % to tick labels
                            color: '#e5e7eb' 
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.15)' }
                    }
                }
            }
        });

        comparisonChartInstanceMajor = newChart;
    }
    
    // ====================================================================
    // --- 6. RENDERING FUNCTIONS (Membangun Struktur HTML) ---
    // ====================================================================

    function renderStudentAttendanceForm() {
        let formSection = '';
        
        if (currentAttendanceRecord) {
            const record = currentAttendanceRecord;
            formSection = `
                <h3 class="text-2xl font-bold text-emerald-300 mb-6 flex items-center">
                    <span data-lucide="check-circle" class="w-6 h-6 mr-2"></span> Absensi Hari Ini Selesai!
                </h3>
                <div class="bg-emerald-700/30 border-l-4 border-emerald-500 p-4 rounded-lg shadow-md transition duration-200 modern-hover text-white">
                    <p class="font-semibold text-emerald-300">Anda telah mengisi absensi pada ${record.date}.</p>
                    <p class="mt-2 text-sm text-white/90">Status Anda: <span class="font-bold">${record.status}</span>. ${record.keterangan && record.keterangan !== '-' ? 'Keterangan: ' + record.keterangan : ''}</p>
                    <p class="mt-2 text-xs text-white/60">Verifikasi Foto Anda: <img src="${record.photo || 'https://placehold.co/100x75/4f46e5/ffffff?text=NO+PHOTO'}" class="h-10 w-10 rounded-full inline-block object-cover"></p>
                </div>
            `;
        } else {
            formSection = `
                <h3 class="text-2xl font-bold text-white mb-6">Isi Absensi Hari Ini</h3>
                <div class="mb-4 p-4 bg-indigo-700/30 border-l-4 border-indigo-500 rounded-lg text-white">
                    <p class="font-semibold text-indigo-300">Tanggal: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                </div>
                <form id="attendance-form" class="space-y-6">
                    <!-- NEW: Camera Section -->
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-white/90">Ambil Foto Kehadiran <span class="text-red-400">*</span></label>
                        <div class="flex flex-col md:flex-row gap-4 items-center">
                            <!-- Video Stream -->
                            <div class="w-full md:w-1/2 rounded-xl overflow-hidden shadow-2xl bg-gray-900 border-4 border-white/30">
                                <video id="video-stream" autoplay playsinline class="w-full h-auto" style="display: block;"></video>
                                <canvas id="photo-canvas" class="hidden w-full h-full"></canvas>
                                <!-- Placeholder for fallback -->
                                <div id="video-fallback" class="w-full h-40 flex items-center justify-center text-white/50 text-sm hidden">
                                    <span data-lucide="video-off" class="w-6 h-6 mr-2"></span> Kamera tidak tersedia atau sedang dimuat.
                                </div>
                            </div>
                            <!-- Capture Button / Photo Preview -->
                            <div class="w-full md:w-1/2 flex flex-col items-center justify-center space-y-3">
                                <button type="button" id="capture-photo-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg shadow-xl modern-hover flex items-center justify-center disabled:opacity-50">
                                    <span data-lucide="camera" class="w-5 h-5 mr-2"></span> Ambil Foto
                                </button>
                                <img id="photo-preview" class="hidden w-full h-auto max-h-48 rounded-xl shadow-2xl border-4 border-emerald-500 object-cover" alt="Preview Foto Absensi">
                                <p id="photo-status" class="text-sm text-white/70">Tekan 'Ambil Foto' untuk verifikasi wajah.</p>
                                <input type="hidden" id="photo-data" name="photo-data" required data-validation-message="Harap ambil foto untuk melanjutkan absensi.">
                            </div>
                        </div>
                    </div>
                    <!-- END: Camera Section -->

                    <div>
                        <label class="block text-sm font-medium text-white/90 mb-2">Status Kehadiran <span class="text-red-400">*</span></label>
                        <div class="flex flex-wrap gap-4" id="status-options">
                            <label class="inline-flex items-center cursor-pointer text-white">
                                <input type="radio" name="status" value="Hadir" required class="form-radio h-5 w-5 text-emerald-400 focus:ring-emerald-300">
                                <span class="ml-2 text-white font-medium">Hadir</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer text-white">
                                <input type="radio" name="status" value="Izin" required class="form-radio h-5 w-5 text-amber-400 focus:ring-amber-300">
                                <span class="ml-2 text-white font-medium">Izin</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer text-white">
                                <input type="radio" name="status" value="Sakit" required class="form-radio h-5 w-5 text-red-400 focus:ring-red-300">
                                <span class="ml-2 text-white font-medium">Sakit</span>
                            </label>
                        </div>
                    </div>

                    <div id="keterangan-group" class="hidden">
                        <label for="keterangan" class="block text-sm font-medium text-white/90 mb-1">Keterangan (Wajib diisi jika Izin/Sakit) <span class="text-red-400">*</span></label>
                        <!-- Updated class for glass element input -->
                        <textarea id="keterangan" name="keterangan" rows="3" placeholder="Contoh: Izin acara keluarga, Sakit demam dan batuk." class="w-full px-4 py-3 border border-white/30 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 glass-element text-white placeholder-white/70"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-lg shadow-xl transform hover:scale-[1.01] transition duration-200 modern-hover">
                        <span data-lucide="send" class="w-5 h-5 mr-2"></span> Kirim Absensi
                    </button>
                </form>
            `;
        }
        
        return formSection;
    }
    // ... (rest of the render functions)

    function renderStudentAttendanceHistory() {
        let historyHtml = `
            <div class="mt-10 pt-6 border-t border-white/30">
                <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                    <span data-lucide="history" class="w-6 h-6 mr-2"></span> Riwayat Absensi Saya
                </h3>
            `;

        if (historyRecords.length === 0) {
            historyHtml += `<p class="text-white/70 text-center py-4">Belum ada riwayat absensi yang tercatat.</p>`;
        } else {
            historyHtml += `
                <div class="overflow-x-auto rounded-lg shadow-lg border border-white/30">
                    <table class="min-w-full divide-y divide-white/20">
                        <thead class="glass-element">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Waktu</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white/10 divide-y divide-white/20">
            `;
            historyRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            historyRecords.forEach(record => {
                let statusClass = '';
                // PERBAIKAN: Warna Alpha menjadi merah menyala
                if (record.status === 'Hadir') statusClass = 'text-emerald-300 bg-emerald-700/30';
                else if (record.status === 'Izin') statusClass = 'text-amber-300 bg-amber-700/30';
                else if (record.status === 'Sakit') statusClass = 'text-red-300 bg-red-700/30';
                else if (record.status === 'Alpha') statusClass = 'text-rose-400 bg-rose-700/50 font-extrabold'; // Merah menyala dan Bold
                
                const formattedTime = formatDateTime(record.date, record.time);

                historyHtml += `
                    <tr class="hover:bg-white/20">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">${record.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${record.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">${formattedTime}</td>
                        <td class="px-6 py-4 text-sm text-white/80 max-w-xs truncate">${record.keterangan || '-'}</td>
                    </tr>
                `;
            });

            historyHtml += `</tbody></table></div>`;
        }

        historyHtml += `</div>`;
        return historyHtml;
    }
    
    function renderProfilePage() {
        return `
            <h3 class="text-2xl font-bold text-white mb-6">Profil ${currentUser.role === 'student' ? 'Siswa' : 'Pengguna'}</h3>
            <div class="space-y-4 glass-element p-6 rounded-xl shadow-inner modern-hover transition duration-200">
                <div class="flex flex-col md:flex-row md:items-center py-2 border-b border-white/20">
                    <span class="w-32 font-medium text-white/70">Nama Lengkap:</span>
                    <span class="font-semibold text-white">${currentUser.nama}</span>
                </div>
                ${currentUser.nisn ? `
                <div class="flex flex-col md:flex-row md:items-center py-2 border-b border-white/20">
                    <span class="w-32 font-medium text-white/70">NISN:</span>
                    <span class="font-semibold text-white">${currentUser.nisn}</span>
                </div>` : ''}
                    ${currentUser.nip ? `
                <div class="flex flex-col md:flex-row md:items-center py-2 border-b border-white/20">
                    <span class="w-32 font-medium text-white/70">NIP:</span>
                    <span class="font-semibold text-white">${currentUser.nip}</span>
                </div>` : ''}
                ${currentUser.kelas ? `
                <div class="flex flex-col md:flex-row md:items-center py-2 border-b border-white/20">
                    <span class="w-32 font-medium text-white/70">Kelas:</span>
                    <span class="font-semibold text-white">${currentUser.kelas}</span>
                </div>` : ''}
                ${currentUser.jurusan ? `
                <div class="flex flex-col md:flex-row md:items-center py-2 border-b border-white/20">
                    <span class="w-32 font-medium text-white/70">Jurusan:</span>
                    <span class="font-semibold text-white">${currentUser.jurusan}</span>
                </div>` : ''}
                <div class="flex flex-col md:flex-row md:items-center py-2">
                    <span class="w-32 font-medium text-white/70">Email:</span>
                    <span class="font-semibold text-white">${currentUser.email || '-'}</span>
                </div>
            </div>
            
            <p class="mt-8 text-sm text-white/70">
                Fitur "Edit Identitas" disimulasikan sebagai tampilan data. Pada sistem nyata, data identitas akan diubah melalui menu Admin.
            </p>
        `;
    }
    
    function generateRecapResultsTemplate(canvasId) {
        const tableBodyId = canvasId.replace('-chart', '-table-body');
        
        return `
            <!-- NEW: Total Summary -->
            <div id="${canvasId}-summary" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 print-hidden">
                <!-- Cards Summary Here -->
            </div>

            <!-- NEW: Chart Container (Glassmorphism + Modern Shadow) -->
            <div class="mb-8 p-6 glass-container rounded-xl modern-shadow border-white/30 print-hidden">
                <h4 class="text-xl font-bold text-white mb-4 flex items-center"><span data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-blue-300"></span> Statistik Kehadiran</h4>
                <div class="chart-container relative h-64 md:h-80">
                    <canvas id="${canvasId}"></canvas>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mb-4 print-hidden">
                <button onclick="handleExport('print')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 modern-hover">
                    <span data-lucide="printer" class="w-4 h-4 mr-2"></span> Cetak
                </button>
                <!-- Database button with modern hover -->
                <button onclick="openGoogleSheetLink()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 modern-hover">
                    <span data-lucide="database" class="w-4 h-4 mr-2"></span> Database
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-lg border border-white/30">
                <table class="min-w-full divide-y divide-white/20">
                    <thead class="glass-element">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">No</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">NISN</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nama Siswa</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Kelas/Jurusan</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Tgl/Waktu</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="${tableBodyId}" class="bg-white/10 divide-y divide-white/20">
                        <!-- Data results here -->
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderTeacherRecap() {
        return `
            <h3 class="text-2xl font-bold text-white mb-6">Rekapitulasi Absensi Siswa (Detail Harian)</h3>
            <div class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="teacher-recap-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="rekap-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="rekap-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Kelas --</option>
                            ${currentUser.kelasAjar ? currentUser.kelasAjar.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Kelas tidak tersedia)</option>`}
                        </select>
                    </div>
                    <div>
                        <label for="rekap-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="rekap-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Jurusan --</option>
                            ${currentUser.jurusanAjar ? currentUser.jurusanAjar.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Jurusan tidak tersedia)</option>`}
                        </select>
                    </div>
                    <div>
                        <label for="rekap-periode" class="block text-sm font-medium text-white/90">Periode</label>
                        <select id="rekap-periode" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="harian" class="bg-indigo-700">Harian</option>
                            <option value="mingguan" class="bg-indigo-700">Mingguan</option>
                            <option value="bulanan" class="bg-indigo-700">Bulanan</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                        <span data-lucide="search" class="w-4 h-4 mr-2"></span> Tampilkan Data
                    </button>
                </form>
            </div>
            
            <div id="recap-results" class="hidden">
                ${generateRecapResultsTemplate('recap-chart')}
            </div>
            <div id="recap-message" class="text-center text-white/70 py-10">Silahkan pilih filter untuk melihat rekap data.</div>
        `;
    }

    // NEW FUNCTION: Render Halaman Rekap Total
    function renderTeacherTotalRecap() {
        const allClasses = currentUser.kelasAjar || [];
        const allMajors = currentUser.jurusanAjar || [];

        return `
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center"><span data-lucide="bar-chart-2" class="w-6 h-6 mr-2"></span> Rekapitulasi Total Absensi Siswa </h3>
            <p class="text-white/90 mb-6">Lihat ringkasan total Hadir/Izin/Sakit/Alpha per siswa dalam periode waktu yang dipilih.</p>
            
            <div id="total-recap-form" class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="rekap-total-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <!-- Kelas & Jurusan -->
                    <div>
                        <label for="total-rekap-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="total-rekap-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Kelas --</option>
                            ${allClasses.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="total-rekap-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="total-rekap-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Jurusan --</option>
                            ${allMajors.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('')}
                        </select>
                    </div>
                    <!-- Pilihan Periode Cepat -->
                    <div class="md:col-span-2">
                        <label for="total-rekap-periode" class="block text-sm font-medium text-white/90">Periode Cepat</label>
                        <select id="total-rekap-periode" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Durasi --</option>
                            <option value="1bulan" class="bg-indigo-700">1 Bulan Terakhir</option>
                            <option value="3bulan" class="bg-indigo-700">3 Bulan Terakhir (Kuartal)</option>
                            <option value="6bulan" class="bg-indigo-700">6 Bulan Terakhir (Semester)</option>
                            <option value="12bulan" class="bg-indigo-700">12 Bulan Terakhir (Tahunan)</option>
                            <option value="custom" class="bg-indigo-700">Rentang Waktu Khusus</option>
                        </select>
                    </div>
                    <!-- Rentang Tanggal Khusus -->
                    <div id="custom-date-group-start" class="hidden">
                        <label for="total-rekap-start-date" class="block text-sm font-medium text-white/90">Dari Tanggal</label>
                        <input type="date" id="total-rekap-start-date" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                    </div>
                    <div id="custom-date-group-end" class="hidden">
                        <label for="total-rekap-end-date" class="block text-sm font-medium text-white/90">Sampai Tanggal</label>
                        <input type="date" id="total-rekap-end-date" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                    </div>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover md:col-span-6 lg:col-span-2">
                        <span data-lucide="calculator" class="w-4 h-4 mr-2"></span> Hitung Rekap Total
                    </button>
                </form>
            </div>

            <div id="total-recap-results" class="hidden">
                <div class="flex justify-end space-x-3 mb-4 print-hidden">
                    <button onclick="window.print()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 modern-hover">
                        <span data-lucide="printer" class="w-4 h-4 mr-2"></span> Cetak
                    </button>
                    <button onclick="openGoogleSheetLink()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 modern-hover">
                        <span data-lucide="database" class="w-4 h-4 mr-2"></span> Database
                    </button>
                </div>
                
                <div class="overflow-x-auto rounded-lg shadow-lg border border-white/30">
                    <table class="min-w-full divide-y divide-white/20">
                        <thead class="glass-element">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">NISN</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Kelas/Jurusan</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-emerald-300 uppercase tracking-wider">Hadir</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-amber-300 uppercase tracking-wider">Izin</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-red-300 uppercase tracking-wider">Sakit</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-rose-400 uppercase tracking-wider">Alpha</th>
                            </tr>
                        </thead>
                        <tbody id="total-recap-table-body" class="bg-white/10 divide-y divide-white/20">
                            <!-- Data summary per siswa di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="total-recap-message" class="text-center text-white/70 py-10">Pilih Kelas, Jurusan, dan Periode untuk menghitung total absensi.</div>
        `;
    }

    function renderTeacherComparison() {
        if (comparisonChartInstanceClass) { comparisonChartInstanceClass.destroy(); comparisonChartInstanceClass = null; }
        if (comparisonChartInstanceMajor) { comparisonChartInstanceMajor.destroy(); comparisonChartInstanceMajor = null; }

        return `
            <h3 class="text-2xl font-bold text-white mb-6">Dashboard Grafik Analisis Kehadiran</h3>
            <p class="text-white/90 mb-6">Lihat perbandingan demografi dan persentase kehadiran siswa antar Kelas atau Jurusan.</p>
            <div class="glass-element p-5 rounded-lg shadow-inner mb-8 print-hidden">
                <form id="comparison-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <!-- Kriteria Perbandingan -->
                    <div>
                        <label for="comparison-filter" class="block text-sm font-medium text-white/90">Kriteria Perbandingan</label>
                        <select id="comparison-filter" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="class" class="bg-indigo-700">Kelas </option>
                            <option value="major" class="bg-indigo-700">Jurusan & Tingkatan</option>
                        </select>
                    </div>
                    <!-- Tingkatan Kelas (Filter Baru) -->
                    <div>
                        <label for="comparison-grade-level" class="block text-sm font-medium text-white/90">Tingkatan Kelas</label>
                        <select id="comparison-grade-level" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Tingkat --</option>
                            <option value="X" class="bg-indigo-700">X</option>
                            <option value="XI" class="bg-indigo-700">XI</option>
                            <option value="XII" class="bg-indigo-700">XII</option>
                        </select>
                    </div>
                    <!-- Empty Div for alignment on md screens -->
                    <div></div> 
                    <div class="md:col-span-1">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                            <span data-lucide="eye" class="w-4 h-4 mr-2"></span> Tampilkan Grafik
                        </button>
                    </div>
                </form>
            </div>

            <div id="comparison-results" class="space-y-10">
                <div id="comparison-message" class="text-center text-white/70 py-10">Pilih kriteria perbandingan di atas untuk menampilkan grafik.</div>

                <!-- Chart 1: Demografi (Jumlah Siswa Total) -->
                <div id="comparison-chart-container" class="hidden p-6 glass-container rounded-xl modern-shadow border-white/30">
                    <h4 id="comparison-chart-title" class="text-xl font-bold text-white mb-4 flex items-center"><span data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-blue-300"></span> Grafik Demografi Siswa (Total)</h4>
                    <div class="chart-container relative h-96 md:h-[500px]">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
                
                <!-- Chart 2: Persentase Kehadiran (Stacked Bar Chart) -->
                <div id="comparison-attendance-chart-container" class="hidden p-6 glass-container rounded-xl modern-shadow border-white/30">
                    <h4 id="comparison-attendance-chart-title" class="text-xl font-bold text-emerald-300 mb-4 flex items-center"><span data-lucide="pie-chart" class="w-5 h-5 mr-2"></span> Grafik Persentase Kehadiran (Hadir, Izin, Sakit, Alpha)</h4>
                    <div class="chart-container relative h-96 md:h-[500px]">
                        <canvas id="comparison-attendance-chart"></canvas>
                    </div>
                </div>

            </div>
        `;
    }

    // NEW FUNCTION: Render Photo Dashboard
    function renderTeacherPhotoDashboard() {
        const allClasses = currentUser.kelasAjar || [];
        const allMajors = currentUser.jurusanAjar || [];
        const currentDate = new Date().toISOString().split('T')[0];

        return `
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center"><span data-lucide="image" class="w-6 h-6 mr-2"></span> Dashboard Foto Absensi Siswa</h3>
            <p class="text-white/90 mb-6">Tampilkan foto kehadiran siswa berdasarkan filter waktu, kelas, dan jurusan.</p>
            
            <div id="photo-dashboard-form" class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="photo-dashboard-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="photo-date" class="block text-sm font-medium text-white/90">Tanggal Foto</label>
                        <input type="date" id="photo-date" value="${currentDate}" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                    </div>
                    <div>
                        <label for="photo-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="photo-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Kelas --</option>
                            ${allClasses.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="photo-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="photo-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Jurusan --</option>
                            ${allMajors.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('')}
                        </select>
                    </div>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                        <span data-lucide="search" class="w-4 h-4 mr-2"></span> Tampilkan Foto
                    </button>
                </form>
                <div class="flex justify-end mt-4">
                     <button onclick="window.print()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-200 modern-hover">
                        <span data-lucide="printer" class="w-4 h-4 mr-2"></span> Cetak Galeri
                    </button>
                </div>
            </div>

            <div id="photo-dashboard-results" class="space-y-6">
                <p id="photo-dashboard-message" class="text-center text-white/70 py-10">Pilih filter dan tekan "Tampilkan Foto" untuk memuat galeri kehadiran.</p>
                
                <div id="photo-grid-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Photo Cards will be inserted here -->
                </div>
                
            </div>
        `;
    }

    function renderTeacherStudentAttendance() {
        const currentDate = new Date().toISOString().split('T')[0];

        return `
            <h3 class="text-2xl font-bold text-white mb-6">Input / Edit Absensi Siswa (Manual)</h3>
            <div class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="manual-attendance-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="manual-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="manual-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Kelas --</option>
                            ${currentUser.kelasAjar ? currentUser.kelasAjar.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Kelas tidak tersedia)</option>`}
                        </select>
                    </div>
                    <div>
                        <label for="manual-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="manual-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Jurusan --</option>
                            ${currentUser.jurusanAjar ? currentUser.jurusanAjar.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Jurusan tidak tersedia)</option>`}
                        </select>
                    </div>
                     <div>
                        <label for="manual-date" class="block text-sm font-medium text-white/90">Tanggal Absensi</label>
                        <input type="date" id="manual-date" value="${currentDate}" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                        <span data-lucide="list-checks" class="w-4 h-4 mr-2"></span> Load Siswa
                    </button>
                </form>
            </div>
            
            <div id="manual-attendance-area" class="mt-8">
                            <p id="manual-message" class="text-center text-white/70 py-10">Pilih Kelas, Jurusan, dan Tanggal untuk memuat daftar siswa.</p>
                        
                            <!-- Student List Table (will be populated dynamically) -->
                            <form id="manual-attendance-submit-form" class="hidden">
                            <div id="student-list-container" class="overflow-x-auto rounded-lg shadow-lg border border-white/30 mb-6">
                                <table class="min-w-full divide-y divide-white/20">
                                    <thead class="glass-element">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">NISN</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nama Siswa</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Keterangan</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider print-hidden">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="student-list-body" class="bg-white/10 divide-y divide-white/20">
                                        <!-- Student rows here -->
                                    </tbody>
                                </table>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-xl transform hover:scale-[1.01] transition duration-200 modern-hover print-hidden">
                                <span data-lucide="save" class="w-5 h-5 mr-2"></span> Simpan Absensi Massal
                            </button>
                            </form>
            </div>
        `;
    }

    function renderTeacherAssessment() {
        const currentDate = new Date().toISOString().split('T')[0];

        return `
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center"><span data-lucide="file-plus" class="w-6 h-6 mr-2"></span> Input Penilaian Siswa</h3>
            <p class="text-white/90 mb-6">Input nilai akan diperbarui ke Google Sheet.</p>
            <div class="glass-element p-5 rounded-xl shadow-inner mb-6 print-hidden">
                <form id="assessment-load-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="assessment-type" class="block text-sm font-medium text-white/90">Jenis Penilaian</label>
                        <select id="assessment-type" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-green-500 focus:border-green-500 glass-element">
                            <option value="harian" class="bg-indigo-700">Penilaian Harian</option>
                            <option value="pts" class="bg-indigo-700">Penilaian Tengah Semester (PTS)</option>
                            <option value="pas" class="bg-indigo-700">Penilaian Akhir Semester (PAS)</option>
                        </select>
                    </div>
                    <div id="assessment-date-group">
                        <label for="assessment-date" class="block text-sm font-medium text-white/90">Tanggal Penilaian</label>
                        <input type="date" id="assessment-date" value="${currentDate}" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-green-500 focus:border-green-500 glass-element">
                    </div>
                    <div>
                        <label for="assessment-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="assessment-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-green-500 focus:border-green-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Kelas --</option>
                            ${currentUser.kelasAjar ? currentUser.kelasAjar.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Kelas tidak tersedia)</option>`}
                        </select>
                    </div>
                    <div>
                        <label for="assessment-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="assessment-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-green-500 focus:border-green-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Pilih Jurusan --</option>
                            ${currentUser.jurusanAjar ? currentUser.jurusanAjar.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('') : `<option value="" class="bg-indigo-700">(Data Jurusan tidak tersedia)</option>`}
                        </select>
                    </div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                        <span data-lucide="file-text" class="w-4 h-4 mr-2"></span> Muat Penilaian
                    </button>
                </form>
            </div>
            
            <div id="assessment-area" class="mt-8">
                <p id="assessment-message" class="text-center text-white/70 py-10">Pilih jenis penilaian, Kelas, dan Jurusan untuk memuat daftar siswa.</p>
                
                <form id="assessment-submit-form" class="hidden">
                    <div id="assessment-student-list-container" class="overflow-x-auto rounded-lg shadow-lg border border-white/30 mb-6">
                        <table class="min-w-full divide-y divide-white/20">
                            <thead class="glass-element">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">NISN</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nama Siswa</th>
                                    <th id="assessment-score-label" class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nilai (0-100)</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider print-hidden">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="assessment-student-list-body" class="bg-white/10 divide-y divide-white/20">
                                <!-- Student rows here -->
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-xl transform hover:scale-[1.01] transition duration-200 modern-hover print-hidden">
                        <span data-lucide="save" class="w-5 h-5 mr-2"></span> Simpan Nilai Massal
                    </button>
                </form>
            </div>
        `;
    }

    function renderAdminConfiguration() {
        return `
            <h3 class="text-2xl font-bold text-white mb-6">Konfigurasi Aplikasi</h3>
            <p class="text-white/90 mb-6">Perbarui detail sekolah yang ditampilkan di header aplikasi.</p>
            <div class="glass-element p-6 rounded-lg shadow-inner mb-8 print-hidden">
                <form id="admin-config-form" class="space-y-6">
                    <div>
                        <label for="config-school-name" class="block text-sm font-medium text-white/90">Nama Sekolah</label>
                        <input type="text" id="config-school-name" value="${APP_CONFIG.SCHOOL_NAME}" required placeholder="Contoh: SMK Sehati Karawang" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </div>
                    <div>
                        <label for="config-logo-url" class="block text-sm font-medium text-white/90">URL Logo Sekolah (Link Langsung)</label>
                        <input type="url" id="config-logo-url" value="${APP_CONFIG.LOGO_URL}" required placeholder="Contoh: https://link-gambar-logo-anda.png" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                        <p class="text-xs text-white/70 mt-1">Gunakan link langsung (Direct Link) atau string Base64 di bawah.</p>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center transition duration-200 modern-hover">
                            <span data-lucide="save" class="w-4 h-4 mr-2"></span> Simpan Konfigurasi
                        </button>
                    </div>
                </form>
            </div>

            <div class="glass-element p-6 rounded-lg shadow-md space-y-4 print-hidden">
                <h4 class="text-lg font-bold text-white">Opsi Alternatif: Logo Base64</h4>
                <div>
                    <label for="config-logo-base64" class="block text-sm font-medium text-white/90">Tempel String Base64 Gambar</label>
                    <textarea id="config-logo-base64" rows="3" placeholder="Contoh: data:image/png;base64,iVBORw0KGgoAAAAN..." class="w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none glass-element"></textarea>
                </div>
                <button id="apply-base64-btn" type="button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center transition duration-200 modern-hover">
                    <span data-lucide="image" class="w-4 h-4 mr-2"></span> Terapkan Logo dari Base64
                </button>
            </div>
        `;
    }

    function renderAdminGlobalRecap() {
        const allClasses = currentUser.kelasAjar || [];
        const allMajors = currentUser.jurusanAjar || []; // DIPERBAIKI: Menggunakan jurusanAjar untuk Jurusan

        return `
            <h3 class="text-2xl font-bold text-white mb-6">Rekapitulasi Global Absensi Siswa (Detail Harian)</h3>
            <div class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="admin-recap-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="admin-rekap-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="admin-rekap-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Kelas --</option>
                            ${allClasses.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="admin-rekap-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="admin-rekap-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Jurusan --</option>
                            ${allMajors.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="admin-rekap-periode" class="block text-sm font-medium text-white/90">Periode</label>
                        <select id="admin-rekap-periode" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                            <option value="harian" class="bg-indigo-700">Harian</option>
                            <option value="mingguan" class="bg-indigo-700">Mingguan</option>
                            <option value="bulanan" class="bg-indigo-700">Bulanan</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center h-10 transition duration-200 modern-hover">
                        <span data-lucide="search" class="w-4 h-4 mr-2"></span> Tampilkan Data
                    </button>
                </form>
            </div>
            
            <div id="admin-recap-results" class="hidden">
                ${generateRecapResultsTemplate('admin-recap-chart')}
            </div>
            <div id="admin-recap-message" class="text-center text-white/70 py-10">Silahkan pilih filter untuk melihat rekap data.</div>
        `;
    }

    function renderAdminManagement() {
        const allClasses = currentUser.kelasAjar || [];
        const allMajors = currentUser.jurusanAjar || [];
        
        return `
            <h3 class="text-2xl font-bold text-white mb-6">Manajemen Data Siswa</h3>
            <p class="text-white/90 mb-6">Kelola data siswa, termasuk penambahan, pengeditan, dan penghapusan massal.</p>
            <div class="glass-element p-5 rounded-lg shadow-inner mb-6 print-hidden">
                <form id="admin-management-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="admin-search-student" class="block text-sm font-medium text-white/90">Cari NISN/Nama</label>
                        <input type="text" id="admin-search-student" placeholder="Ketik NISN atau Nama Siswa" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                    </div>
                    <div>
                        <label for="admin-filter-kelas" class="block text-sm font-medium text-white/90">Kelas</label>
                        <select id="admin-filter-kelas" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Kelas --</option>
                            ${allClasses.map(c => `<option value="${c}" class="bg-indigo-700">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="admin-filter-jurusan" class="block text-sm font-medium text-white/90">Jurusan</label>
                        <select id="admin-filter-jurusan" class="mt-1 w-full px-3 py-2 border border-white/30 rounded-lg focus:ring-purple-500 focus:border-purple-500 glass-element">
                            <option value="" class="bg-indigo-700">-- Semua Jurusan --</option>
                            ${allMajors.map(j => `<option value="${j}" class="bg-indigo-700">${j}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-4 flex justify-end">
                               <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg flex items-center justify-center transition duration-200 modern-hover">
                                   <span data-lucide="filter" class="w-4 h-4 mr-2"></span> Terapkan Filter
                               </button>
                    </div>
                </form>
            </div>
            
            <p id="admin-management-message" class="text-center text-white/70 py-10">Memuat data siswa...</p>
            
            <form id="admin-student-update-form" class="hidden">
                             <div class="flex flex-col space-y-3 md:flex-row justify-between items-center mb-4 md:space-y-0 print-hidden">
                             <button type="button" onclick="openAddStudentModal()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-md justify-center transition duration-200 modern-hover">
                                 <span data-lucide="user-plus" class="w-4 h-4 mr-2"></span> Tambah Siswa Baru
                             </button>
                             
                             <div class="flex space-x-3 w-full md:w-auto">
                                 <button onclick="openGoogleSheetLink()" type="button" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-md justify-center transition duration-200 modern-hover">
                                     <span data-lucide="external-link" class="w-4 h-4 mr-2"></span> Edit Data di Sheet
                                 </button>
                                 <!-- NEW BULK DELETE BUTTON (Perbaikan 3) -->
                                 <button onclick="handleDeleteFilteredStudents()" type="button" id="bulk-delete-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center shadow-md justify-center disabled:opacity-50" disabled>
                                     <span data-lucide="trash-2" class="w-4 h-4 mr-2"></span> Hapus Berdasarkan Filter (<span id="filtered-count">0</span>)
                                 </button>
                             </div>
                             </div>

                <div id="admin-student-list-container" class="overflow-x-auto rounded-lg shadow-lg border border-white/30 mb-6">
                    <table class="min-w-full divide-y divide-white/20">
                        <thead class="glass-element">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">NISN (KEY)</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Jurusan</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider print-hidden">Password</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider print-hidden">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-student-list-body" class="bg-white/10 divide-y divide-white/20">
                            <!-- Student rows here -->
                        </tbody>
                    </table>
                </div>
                                     <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-xl transform hover:scale-[1.01] transition duration-200 modern-hover print-hidden">
                        <span data-lucide="save" class="w-5 h-5 mr-2"></span> Simpan Perubahan Data Massal
                    </button>
            </form>
        `;
    }

    // ====================================================================
    // --- 7. HANDLER & LISTENER FUNCTIONS (Logic Interaktif) ---
    // ====================================================================

    // --- Camera/Photo Capture Logic ---

    function stopCamera() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
            if (videoElement) {
                videoElement.srcObject = null;
                // Optional cleanup for UI elements
                videoElement.classList.add('hidden');
                document.getElementById('video-fallback').classList.remove('hidden');
            }
        }
    }

    async function startCamera() {
        // Assign elements to global variables inside this function as they are rendered dynamically
        videoElement = document.getElementById('video-stream');
        canvasElement = document.getElementById('photo-canvas');
        photoDataInput = document.getElementById('photo-data');
        photoPreview = document.getElementById('photo-preview');
        captureButton = document.getElementById('capture-photo-btn');
        const fallbackDiv = document.getElementById('video-fallback');
        
        if (!videoElement || !canvasElement || !captureButton) return;

        // Reset state
        photoPreview.classList.add('hidden');
        photoPreview.src = '';
        photoDataInput.value = '';
        captureButton.removeAttribute('disabled');
        videoElement.classList.add('hidden');
        fallbackDiv.classList.remove('hidden');
        document.getElementById('photo-status').textContent = 'Tekan "Ambil Foto" untuk verifikasi wajah.';


        try {
            stopCamera(); // Ensure previous stream is stopped
            
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "user" // Use front camera
                },
                audio: false
            });
            
            videoElement.srcObject = mediaStream;
            videoElement.classList.remove('hidden');
            fallbackDiv.classList.add('hidden');

            // Wait for video metadata to load
            await new Promise(resolve => {
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    resolve();
                };
            });

            captureButton.onclick = capturePhoto;
            
        } catch (err) {
            console.error("Error accessing camera: ", err);
            videoElement.classList.add('hidden');
            fallbackDiv.classList.remove('hidden');
            fallbackDiv.innerHTML = '<span class="text-red-400">Gagal mengakses kamera. Harap izinkan akses.</span>';
            captureButton.setAttribute('disabled', 'disabled');
            document.getElementById('photo-status').innerHTML = '<span class="text-red-400 font-semibold">Kamera tidak aktif. Absensi tidak dapat dilanjutkan.</span>';
        }
    }

    function capturePhoto() {
        if (!videoElement || !canvasElement || !mediaStream || captureButton.hasAttribute('disabled')) {
            showModal('Kamera Belum Aktif', 'Harap tunggu kamera aktif, izinkan akses, atau refresh halaman.', 'error', 3000);
            return;
        }

        // Set canvas dimensions to video dimensions
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        const ctx = canvasElement.getContext('2d');
        ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

        // Convert canvas image to Base64 JPEG format (compressed for efficiency)
        const base64Data = canvasElement.toDataURL('image/jpeg', 0.8); // 80% quality

        // Update hidden input and preview
        photoDataInput.value = base64Data;
        photoPreview.src = base64Data;
        photoPreview.classList.remove('hidden');
        videoElement.classList.add('hidden');
        document.getElementById('video-fallback').classList.add('hidden'); // Hide fallback just in case
        
        captureButton.setAttribute('disabled', 'disabled'); // Prevent re-capture until submission
        document.getElementById('photo-status').innerHTML = '<span class="text-emerald-300 font-semibold">Foto berhasil diambil! Lanjutkan isi absensi.</span>';
    }
    
    // --- Student Handlers (Updated) ---

    function setupAttendanceFormListeners() {
        const form = document.getElementById('attendance-form');
        if (!form) return;
        
        // --- NEW: Camera Init ---
        startCamera();
        // --- END NEW: Camera Init ---

        const statusOptions = document.getElementById('status-options');
        const keteranganGroup = document.getElementById('keterangan-group');
        const keteranganInput = document.getElementById('keterangan');

        statusOptions.addEventListener('change', (e) => {
            const status = e.target.value;
            if (status === 'Izin' || status === 'Sakit') {
                keteranganGroup.classList.remove('hidden');
                keteranganInput.setAttribute('required', 'required');
            } else {
                keteranganGroup.classList.add('hidden');
                keteranganInput.removeAttribute('required');
                keteranganInput.value = '';
            }
        });

        form.addEventListener('submit', handleAttendanceSubmission);
    }

    async function handleAttendanceSubmission(e) {
        e.preventDefault();

        const form = e.target;
        const status = form.querySelector('input[name="status"]:checked').value;
        const keterangan = form.querySelector('#keterangan').value.trim();
        
        // --- NEW: Photo Data Validation ---
        const photoData = document.getElementById('photo-data').value;
        if (!photoData) {
            showModal('Validasi Foto', 'Harap ambil foto kehadiran Anda terlebih dahulu.', 'error', 3000);
            return;
        }
        // --- END NEW: Photo Data Validation ---

        showModal('Mengirim Data', 'Sedang mengirim data absensi Anda, mohon menunggu...', 'loading', 0);

        const payload = new URLSearchParams({
            action: 'saveAttendance',
            nisn: currentUser.nisn,
            nama: currentUser.nama,
            kelas: currentUser.kelas,
            jurusan: currentUser.jurusan,
            status: status,
            keterangan: keterangan,
            submittedBy: 'Siswa Mandiri',
            photo: photoData // --- NEW: Send photo data ---
        });

        const result = await postData(payload);
        hideModal(); 
        
        // Stop camera immediately after receiving response (regardless of success/fail)
        stopCamera();

        if (result && result.status === 'success') {
            const submissionTime = getTimeString(new Date());
            showModal('Absensi Berhasil!', `Data absensi berhasil dikirim. Status Anda: ${status}. Dikirim pada ${submissionTime} WIB.`, 'success', 3000);
            setTimeout(() => { selectTab('absensi'); }, 50);
        } else {
            showModal('Absensi Gagal!', result ? result.message : 'Terjadi kesalahan saat menyimpan data.', 'error', 5000);
        }
    }
    
    // --- NEW: Implementasi Fungsi Rekap (FIX BUG) ---

    // Helper untuk render tabel detail rekap (Harian/Mingguan/Bulanan)
    function renderRecapTable(records, tableBodyId) {
        const tableBody = document.getElementById(tableBodyId);
        tableBody.innerHTML = '';

        records.forEach((record, index) => {
            let statusClass = '';
            if (record.status === 'Hadir') statusClass = 'text-emerald-300 bg-emerald-700/30';
            else if (record.status === 'Izin') statusClass = 'text-amber-300 bg-amber-700/30';
            else if (record.status === 'Sakit') statusClass = 'text-red-300 bg-red-700/30';
            else if (record.status === 'Alpha') statusClass = 'text-rose-400 bg-rose-700/50 font-extrabold';
            
            const formattedTime = formatDateTime(record.date, record.time);

            const row = document.createElement('tr');
            row.className = 'hover:bg-white/10';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white/90">${record.nisn || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">${record.nama || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">${record.kelas || '-'}/${record.jurusan || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">${record.date || '-'} / ${formattedTime}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${record.status || '-'}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-white/80 max-w-xs truncate">${record.keterangan || '-'}</td>
            `;
            tableBody.appendChild(row);
        });
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }


    // Implementasi displayRecap untuk Detail Harian (Teacher/Admin)
    async function displayRecap(kelas, jurusan, periode, resultsId, messageId, tableBodyId, chartId, action) {
        const resultsDiv = document.getElementById(resultsId);
        const messageDiv = document.getElementById(messageId);
        const tableBody = document.getElementById(tableBodyId);

        resultsDiv.classList.add('hidden');
        messageDiv.classList.remove('hidden');
        tableBody.innerHTML = '';
        
        // Display loading message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat data rekap ${periode} untuk ${kelas || 'Semua Kelas'}-${jurusan || 'Semua Jurusan'}...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();

        const url = `${WEB_APP_URL}?action=${action}&kelas=${kelas}&jurusan=${jurusan}&periode=${periode}`;
        const result = await fetchData(url);
        
        // Store filters for printing
        currentRecapFilters = { kelas, jurusan, periode, type: 'detail' };

        if (result && result.status === 'success' && result.records) {
            currentRecapData = result.records;
            const summaryData = result.summary || { 'Total': 0 }; // Ensure summary exists

            if (currentRecapData.length === 0) {
                messageDiv.innerHTML = `<p class="font-semibold text-white/90">Tidak ditemukan data absensi untuk filter yang dipilih.</p>`;
                return;
            }

            renderRecapTable(currentRecapData, tableBodyId);
            renderRecapSummary(`${chartId}-summary`, summaryData);
            renderAttendanceChart(chartId, summaryData);

            messageDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');

        } else {
            // FIX for "Gagal memuat rekap. undefined"
            const errorMessage = result ? (result.message || 'Error tidak terduga dari server Apps Script. Pastikan fungsi Apps Script **getRecap** sudah di-redeploy.') : 'Gagal terhubung ke server Apps Script. Periksa koneksi atau konfigurasi URL.';
            messageDiv.innerHTML = `<p class="font-semibold text-red-400">Gagal memuat rekap. ${errorMessage}</p>`;
            currentRecapData = []; // Clear data on failure
            currentRecapFilters = {}; // Clear filters
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }


    // Helper untuk render tabel rekap total
    function renderTotalRecapTable(summaryRecords) {
        const tableBody = document.getElementById('total-recap-table-body');
        tableBody.innerHTML = '';

        summaryRecords.forEach((record, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-white/10';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white/90">${record.nisn || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">${record.nama || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">${record.kelas || '-'}/${record.jurusan || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-emerald-300">${record.Hadir || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-amber-300">${record.Izin || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-red-300">${record.Sakit || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-rose-400">${record.Alpha || 0}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Implementasi displayTotalRecap untuk Rekap Total
    async function displayTotalRecap(kelas, jurusan, periode, startDate, endDate) {
        const resultsDiv = document.getElementById('total-recap-results');
        const messageDiv = document.getElementById('total-recap-message');
        const tableBody = document.getElementById('total-recap-table-body');

        resultsDiv.classList.add('hidden');
        messageDiv.classList.remove('hidden');
        tableBody.innerHTML = '';
        
        // Display loading message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Menghitung rekap total...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        let url = `${WEB_APP_URL}?action=getTotalRecap&kelas=${kelas}&jurusan=${jurusan}&periode=${periode}`;
        if (periode === 'custom') {
            url += `&startDate=${startDate}&endDate=${endDate}`;
        }

        const result = await fetchData(url);
        
        // Store filters for printing
        currentRecapFilters = { kelas, jurusan, periode, startDate, endDate, type: 'total' };

        if (result && result.status === 'success' && result.summary) {
            currentTotalRecapData = result.summary;

            if (currentTotalRecapData.length === 0) {
                messageDiv.innerHTML = `<p class="font-semibold text-white/90">Tidak ditemukan data total absensi untuk filter yang dipilih. Pastikan ada data absensi dalam rentang waktu tersebut.</p>`;
                return;
            }

            renderTotalRecapTable(currentTotalRecapData);
            messageDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');

        } else {
            // FIX for "Gagal memuat rekap. undefined"
            const errorMessage = result ? (result.message || 'Error tidak terduga dari server Apps Script. Pastikan fungsi Apps Script **getTotalRecap** sudah di-redeploy.') : 'Gagal terhubung ke server Apps Script. Periksa koneksi atau konfigurasi URL.';
            messageDiv.innerHTML = `<p class="font-semibold text-red-400">Gagal memuat rekap total. ${errorMessage}</p>`;
            currentTotalRecapData = []; // Clear data on failure
            currentRecapFilters = {}; // Clear filters
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }


    // --- Teacher Recap Handlers (Detail Harian) ---

    function setupTeacherRecapListeners() {
        const form = document.getElementById('teacher-recap-form');
        if (!form) return;
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const kelas = document.getElementById('rekap-kelas').value;
            const jurusan = document.getElementById('rekap-jurusan').value;
            const periode = document.getElementById('rekap-periode').value;

            displayRecap(kelas, jurusan, periode, 'recap-results', 'recap-message', 'recap-table-body', 'recap-chart', 'getRecap');
        });
    }

    // NEW HANDLER: Teacher Photo Dashboard
    function setupTeacherPhotoDashboardListeners() {
        const form = document.getElementById('photo-dashboard-filter-form');
        if (form) {
            form.addEventListener('submit', handleLoadPhotos);
        }
    }
    
    // NEW FUNCTION: Handle Load Photos
    async function handleLoadPhotos(e) {
        e.preventDefault();
        const date = document.getElementById('photo-date').value;
        const kelas = document.getElementById('photo-kelas').value;
        const jurusan = document.getElementById('photo-jurusan').value;
        const messageDiv = document.getElementById('photo-dashboard-message');
        const gridContainer = document.getElementById('photo-grid-container');

        messageDiv.classList.remove('hidden');
        gridContainer.innerHTML = '';
        
        if (!date) {
            messageDiv.innerHTML = `<p class="font-semibold text-red-500">Harap masukkan Tanggal Foto yang valid.</p>`;
            return;
        }

        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat galeri foto absensi untuk ${date}...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();

        const url = `${WEB_APP_URL}?action=getAttendancePhotos&date=${date}&kelas=${kelas}&jurusan=${jurusan}`;
        const result = await fetchData(url);

        if (result && result.status === 'success' && result.photos) {
            const photoRecords = result.photos;

            if (photoRecords.length === 0) {
                messageDiv.innerHTML = `<p class="font-semibold text-white/90">Tidak ditemukan foto absensi untuk tanggal dan filter yang dipilih.</p>`;
            } else {
                messageDiv.classList.add('hidden');
                renderPhotoGrid(photoRecords);
            }

        } else {
            const msg = result ? result.message : 'Gagal memuat foto.';
            messageDiv.innerHTML = `<p class="font-semibold text-red-500">Error: ${msg}. Pastikan fungsi Apps Script **getAttendancePhotos** sudah di-redeploy.</p>`;
        }
    }

    // NEW FUNCTION: Render Photo Grid
    function renderPhotoGrid(photos) {
        const gridContainer = document.getElementById('photo-grid-container');
        gridContainer.innerHTML = ''; // Clear previous content

        photos.forEach(photo => {
            let statusClass = '';
            // Match color scheme for status
            if (photo.status === 'Hadir') statusClass = 'text-emerald-300 border-emerald-500';
            else if (photo.status === 'Izin') statusClass = 'text-amber-300 border-amber-500';
            else if (photo.status === 'Sakit') statusClass = 'text-red-300 border-red-500';
            else if (photo.status === 'Alpha') statusClass = 'text-rose-400 border-rose-500';

            const photoCard = document.createElement('div');
            // Elegant photo card design
            photoCard.className = `glass-element rounded-xl overflow-hidden shadow-2xl modern-hover transition duration-300 border border-white/30`;
            
            photoCard.innerHTML = `
                <div class="h-48 w-full bg-gray-900 overflow-hidden">
                    <img src="${photo.photo || 'https://placehold.co/400x300/111827/9ca3af?text=NO+PHOTO+DATA'}" 
                         alt="Absensi ${photo.nama}" 
                         class="w-full h-full object-cover transform hover:scale-110 transition duration-500 cursor-zoom-in"
                         onclick="showModal('Foto Kehadiran: ${photo.nama}', '<img src=\\'${photo.photo || 'https://placehold.co/800x600/111827/9ca3af?text=NO+PHOTO+DATA'}\\' class=\\'w-full h-auto rounded-lg shadow-xl\\'>', 'info', 0, 'image')">
                </div>
                <div class="p-4 space-y-1">
                    <p class="text-lg font-bold text-white truncate">${photo.nama}</p>
                    <p class="text-sm font-medium text-white/70">NISN: ${photo.nisn}</p>
                    <p class="text-sm text-white/80">${photo.kelas || '-'}/${photo.jurusan || '-'} - ${photo.date}</p>
                    <div class="flex justify-between items-center pt-2 border-t border-white/10">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-white/10 ${statusClass}">
                            ${photo.status || 'T/A'}
                        </span>
                        <span class="text-xs text-white/60 flex items-center">
                            <span data-lucide="clock" class="w-3 h-3 mr-1"></span> ${photo.time || '--:--'} WIB
                        </span>
                    </div>
                </div>
            `;
            gridContainer.appendChild(photoCard);
        });

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // NEW HANDLER: Teacher Total Recap
    function setupTeacherTotalRecapListeners() {
        const form = document.getElementById('rekap-total-form');
        const periodeSelect = document.getElementById('total-rekap-periode');
        const startDateGroup = document.getElementById('custom-date-group-start');
        const endDateGroup = document.getElementById('custom-date-group-end');

        if (!form) return;
        
        periodeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                startDateGroup.classList.remove('hidden');
                endDateGroup.classList.remove('hidden');
            } else {
                startDateGroup.classList.add('hidden');
                endDateGroup.classList.add('hidden');
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const kelas = document.getElementById('total-rekap-kelas').value;
            const jurusan = document.getElementById('total-rekap-jurusan').value;
            const periode = periodeSelect.value;
            let startDate = '';
            let endDate = '';
            let isValid = true;

            if (periode === 'custom') {
                startDate = document.getElementById('total-rekap-start-date').value;
                endDate = document.getElementById('total-rekap-end-date').value;
                if (!startDate || !endDate) {
                    showModal('Validasi Input', 'Harap lengkapi tanggal Mulai dan Akhir untuk periode khusus.', 'error', 3000);
                    isValid = false;
                } else if (new Date(startDate) > new Date(endDate)) {
                    showModal('Validasi Tanggal', 'Tanggal Mulai tidak boleh lebih dari Tanggal Akhir.', 'error', 3000);
                    isValid = false;
                }
            } else if (!periode) {
                 showModal('Validasi Input', 'Harap pilih Kelas, Jurusan, dan Periode yang valid.', 'error', 3000);
                 isValid = false;
            }

            if (isValid) {
                displayTotalRecap(kelas, jurusan, periode, startDate, endDate);
            }
        });
    }

    // --- Teacher Comparison Handlers ---

    function setupTeacherComparisonListeners() {
        const form = document.getElementById('comparison-form');
        if (!form) return;
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const filterType = document.getElementById('comparison-filter').value;
            displayComparisonCharts(filterType);
        });
    }

    // NEW FUNCTION: Implementasi logic displayComparisonCharts
    async function displayComparisonCharts(filterType) {
        const messageDiv = document.getElementById('comparison-message');
        const demoContainer = document.getElementById('comparison-chart-container');
        const attendContainer = document.getElementById('comparison-attendance-chart-container');

        demoContainer.classList.add('hidden');
        attendContainer.classList.add('hidden');
        messageDiv.classList.remove('hidden');
        // PERBAIKAN: Kontras dan Ukuran Loading Message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat data perbandingan ${filterType === 'class' ? 'kelas' : 'jurusan'}...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // 1. Fetch Comparison Data
        const gradeLevel = document.getElementById('comparison-grade-level').value; // NEW

        const url = `${WEB_APP_URL}?action=getComparisonData&filterType=${filterType}&gradeLevel=${gradeLevel}&role=${currentUser.role}&nip=${currentUser.nip || ''}`; // UPDATED URL
        const result = await fetchData(url);

        if (!result || result.status !== 'success' || !result.demographic || !result.attendance_percent) {
            messageDiv.innerHTML = `<p class="font-semibold text-red-400">${result ? (result.message || 'Gagal memuat data perbandingan. Pastikan fungsi Apps Script **getComparisonData** sudah di-redeploy.') : 'Gagal memuat data perbandingan (Error Koneksi/Server).'}</p>`;
            return;
        }

        const demographicData = result.demographic; 
        const attendanceData = result.attendance_percent; 
        
        if (demographicData.length === 0) {
            messageDiv.innerHTML = `<p class="font-semibold text-white/90">Tidak ada data siswa atau kehadiran yang cukup untuk perbandingan ini.</p>`;
            // Clear existing charts
            if (comparisonChartInstanceClass) { comparisonChartInstanceClass.destroy(); comparisonChartInstanceClass = null; }
            if (comparisonChartInstanceMajor) { comparisonChartInstanceMajor.destroy(); comparisonChartInstanceMajor = null; }
            return;
        }

        // 2. Render Demographic Chart
        let chartTitleDemo;
        if (filterType === 'class') {
            chartTitleDemo = 'Jumlah Total Siswa per Kelas';
        } else if (filterType === 'major') {
            chartTitleDemo = `Jumlah Total Siswa per Jurusan & Tingkat (${gradeLevel || 'Semua Tingkat'})`; // UPDATED TITLE
        }
        renderDemographicChart('comparison-chart', demographicData, chartTitleDemo);
        demoContainer.classList.remove('hidden');
        document.getElementById('comparison-chart-title').textContent = chartTitleDemo;

        // 3. Render Attendance Percentage Chart
        renderAttendanceComparisonChart('comparison-attendance-chart', attendanceData, filterType);
        attendContainer.classList.remove('hidden');

        messageDiv.classList.add('hidden');
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    
    // --- Teacher Manual Attendance Handlers ---

    function setupTeacherStudentAttendanceListeners() {
        const loadForm = document.getElementById('manual-attendance-form');
        const submitForm = document.getElementById('manual-attendance-submit-form');
        
        if (!loadForm || !submitForm) return;
        
        loadForm.addEventListener('submit', handleLoadStudentList);
        submitForm.addEventListener('submit', handleSubmitManualAttendance);
        
        const tableBody = document.getElementById('student-list-body');
        tableBody.removeEventListener('change', handleAttendanceStatusChange);
        tableBody.addEventListener('change', handleAttendanceStatusChange); 
    }
    
    function handleAttendanceStatusChange(e) {
        if (e.target.tagName.toLowerCase() === 'select' && e.target.name.startsWith('status_')) {
            const status = e.target.value;
            const row = e.target.closest('tr');
            const keteranganInput = row.querySelector(`textarea[name^="keterangan_"]`);

            if (status === 'Hadir' || status === 'Alpha') {
                keteranganInput.setAttribute('disabled', 'disabled');
                keteranganInput.classList.add('bg-gray-100');
                if (status === 'Alpha') {
                    keteranganInput.value = 'Alfa'; // Set default ket for Alpha
                } else if (status === 'Hadir') {
                    keteranganInput.value = '-'; // Set default ket for Hadir
                }
            } else {
                keteranganInput.removeAttribute('disabled');
                keteranganInput.classList.remove('bg-gray-100');
                if (keteranganInput.value === 'Alfa' || keteranganInput.value === '-') {
                    keteranganInput.value = '';
                }
            }
            
            if (status === 'Izin' || status === 'Sakit') {
                const keteranganValue = keteranganInput.value.trim();
                if (keteranganValue) {
                    showMiniPopup('keterangan', keteranganInput, keteranganValue);
                }
            } else if (status === 'Hadir') {
                showMiniPopup('hadir', e.target, 'Hadir');
            } else {
                hideMiniPopup();
            }

        } else if (e.target.tagName.toLowerCase() === 'textarea' && e.target.name.startsWith('keterangan_')) {
            const keterangan = e.target.value.trim();
            const row = e.target.closest('tr');
            const statusSelect = row.querySelector(`select[name^="status_"]`);
            
            if ((statusSelect.value === 'Izin' || statusSelect.value === 'Sakit') && keterangan) {
                showMiniPopup('keterangan', e.target, keterangan);
            } else {
                hideMiniPopup();
            }
        }
    }

    async function handleLoadStudentList(e) {
        e.preventDefault();
        const kelas = document.getElementById('manual-kelas').value;
        const jurusan = document.getElementById('manual-jurusan').value;
        const date = document.getElementById('manual-date').value;
        const messageDiv = document.getElementById('manual-message');
        const submitForm = document.getElementById('manual-attendance-submit-form');
        
        submitForm.classList.add('hidden'); messageDiv.classList.remove('hidden');
        // PERBAIKAN: Kontras dan Ukuran Loading Message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat daftar siswa dan status absensi...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        if (!kelas || !jurusan || !date) {
             messageDiv.innerHTML = `<p class="font-semibold text-red-500">Harap pilih Kelas, Jurusan, dan Tanggal yang valid.</p>`;
             return;
        }

        const url = `${WEB_APP_URL}?action=getStudentListWithStatus&kelas=${kelas}&jurusan=${jurusan}&date=${date}`;
        const result = await fetchData(url);
        
        let studentListWithStatus = [];
        if (result && result.status === 'success' && result.students) {
            studentListWithStatus = result.students;
        } else {
             if (result && result.message && result.message.includes('Aksi tidak dikenali.')) {
                 messageDiv.innerHTML = `<p class="font-semibold text-red-500">Error Server: Fungsi "getStudentListWithStatus" tidak ditemukan. Harap pastikan Anda telah menyimpan dan **REDEPLOY** Apps Script terbaru.</p>`;
             } else {
                 messageDiv.innerHTML = `<p class="font-semibold text-red-500">${result ? result.message : 'Gagal memuat data siswa (Error tidak terduga).'}</p>`;
             }
             return;
        }

        renderStudentAttendanceTable(studentListWithStatus, kelas, jurusan, date);

        if (studentListWithStatus.length > 0) {
            messageDiv.classList.add('hidden');
            submitForm.classList.remove('hidden');
        } else {
            messageDiv.classList.remove('hidden');
            messageDiv.innerHTML = `<p class="font-semibold text-gray-700">Tidak ditemukan siswa di Kelas ${kelas} Jurusan ${jurusan}. Pastikan data di Sheet "DATA SISWA" sudah benar.</p>`;
        }
    }

    function renderStudentAttendanceTable(students, kelas, jurusan, date) {
        const body = document.getElementById('student-list-body');
        body.innerHTML = '';
        
        students.forEach((student, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-white/10';
            
            const statusOptions = ['Hadir', 'Izin', 'Sakit', 'Alpha'];
            let statusSelect = `<select name="status_${student.nisn}" class="w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">`;
            
            statusOptions.forEach(option => {
                const selected = student.status === option ? 'selected' : '';
                statusSelect += `<option value="${option}" class="bg-indigo-700" ${selected}>${option}</option>`;
            });
            statusSelect += `</select>`;
            
            // Perbaikan logic: Jika status Hadir/Alpha, kolom keterangan harus didisable.
            const isKeteranganDisabled = student.status === 'Hadir' || student.status === 'Alpha';
            const keteranganClass = isKeteranganDisabled ? 'bg-white/10' : 'bg-white/20';
            // Perbaikan logic: Pastikan Hadir/Alpha memiliki default '-' atau 'Alfa' di UI (meski di Apps Script akan diabaikan)
            let initialKeterangan = student.keterangan === '-' ? '' : student.keterangan || '';
            if (student.status === 'Alpha' && initialKeterangan === '') initialKeterangan = 'Alfa';
            if (student.status === 'Hadir' && initialKeterangan === '') initialKeterangan = '-';


            row.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-white/90">
                    ${student.nisn}
                    <input type="hidden" name="nisn" value="${student.nisn}">
                    <input type="hidden" name="nama_${student.nisn}" value="${student.nama}">
                    <input type="hidden" name="kelas_${student.nisn}" value="${kelas}">
                    <input type="hidden" name="jurusan_${student.nisn}" value="${jurusan}">
                    <input type="hidden" name="date" value="${date}">
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-white/90">${student.nama}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm">
                    ${statusSelect}
                </td>
                <td class="px-4 py-4 text-sm text-white/80">
                    <textarea name="keterangan_${student.nisn}" rows="1" placeholder="Keterangan (jika Izin/Sakit)" class="w-full px-3 py-2 border border-white/30 rounded-md resize-none ${keteranganClass} text-white placeholder-white/70" ${isKeteranganDisabled ? 'disabled' : ''}>${initialKeterangan}</textarea>
                </td>
                <!-- FIX BUG 2: Tombol Simpan Individual -->
                <td class="px-4 py-4 whitespace-nowrap text-sm text-white/80 print-hidden">
                    <button type="button" onclick="handleSingleManualAttendanceUpdate('${student.nisn}')" 
                        class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold py-1 px-3 rounded-lg shadow-md transition duration-150 modern-hover">
                        <span data-lucide="save" class="w-4 h-4 mr-1"></span> Simpan
                    </button>
                </td>
            `;
            body.appendChild(row);
        });
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function handleSingleManualAttendanceUpdate(nisn) {
        const form = document.getElementById('manual-attendance-submit-form');
        if (!form) return;

        const status = form.querySelector(`select[name="status_${nisn}"]`).value;
        const keteranganInput = form.querySelector(`textarea[name="keterangan_${nisn}"]`);
        
        let keterangan = keteranganInput.value.trim();
        const nama = form.querySelector(`input[name="nama_${nisn}"]`).value;
        const kelas = form.querySelector(`input[name="kelas_${nisn}"]`).value;
        const jurusan = form.querySelector(`input[name="jurusan_${nisn}"]`).value;
        const dateInput = form.querySelector('input[name="date"]').value;

        // Logic: Jika Hadir/Alpha, kosongkan keterangan sebelum dikirim
        if (status === 'Hadir' || status === 'Alpha') {
            keterangan = '-'; 
        } else if (keterangan === '') {
            keterangan = '-'; 
        }
        
        const submissionTime = getTimeString(new Date()); 
        const time = (status === 'Hadir') ? submissionTime : ''; 

        const updates = [{ 
            nisn, nama, kelas, jurusan, date: dateInput, status, 
            keterangan: keterangan, time: time,
        }];

        showModal('Mengirim Data', `Menyimpan absensi ${nama} (${status}) secara individual...`, 'loading', 0);

        const payload = new URLSearchParams({
            action: 'handleManualAttendanceUpdate',
            updates: JSON.stringify(updates),
            submittedBy: currentUser.role
        });

        const result = await postData(payload);
        hideModal();
        
        if (result && result.status === 'success') {
            showModal('Penyimpanan Berhasil', `Absensi ${nama} berhasil diperbarui.`, 'success', 3000);
            
            // Re-load the list to update the 'updated_at' time if needed
            const loadForm = document.getElementById('manual-attendance-form');
            if (loadForm) {
                 // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
                 setTimeout(() => loadForm.dispatchEvent(new Event('submit')), 50); 
            } else {
                 selectTab('absensi-siswa'); 
            }

        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan data absensi tunggal.', 'error', 5000);
        }
    }


    async function handleSubmitManualAttendance(e) {
        e.preventDefault();
        
        const form = e.target;
        const nisnInputs = form.querySelectorAll('input[name="nisn"]');
        const dateInput = form.querySelector('input[name="date"]').value;
        const updates = [];
        
        const submissionTime = getTimeString(new Date()); 
        
        nisnInputs.forEach(input => {
            const nisn = input.value;
            const status = form.querySelector(`select[name="status_${nisn}"]`).value;
            const keteranganInput = form.querySelector(`textarea[name="keterangan_${nisn}"]`);
            
            // Perbaikan: Pastikan kita mengambil nilai yang benar (bukan hanya status disabled)
            let keterangan = keteranganInput.value.trim();
            
            // Logic perbaikan bug: Jika Hadir/Alpha, kosongkan keterangan sebelum dikirim
            if (status === 'Hadir' || status === 'Alpha') {
                keterangan = '-'; 
            } else if (keterangan === '') {
                // Wajib isi jika Izin/Sakit, tapi jika kosong, berikan feedback di Apps Script
                 keterangan = '-'; 
            }


            const nama = form.querySelector(`input[name="nama_${nisn}"]`).value;
            const kelas = form.querySelector(`input[name="kelas_${nisn}"]`).value;
            const jurusan = form.querySelector(`input[name="jurusan_${nisn}"]`).value;

            // Perbaikan Logic: Waktu hanya diisi jika statusnya 'Hadir'
            const time = (status === 'Hadir') ? submissionTime : ''; 

            updates.push({ 
                nisn, nama, kelas, jurusan, date: dateInput, status, 
                keterangan: keterangan, time: time,
            });
        });
        
        if (updates.length === 0) return;
        
        showModal('Mengirim Data', 'Menyimpan absensi manual massal...', 'loading', 0);

        const payload = new URLSearchParams({
            action: 'handleManualAttendanceUpdate',
            updates: JSON.stringify(updates),
            submittedBy: currentUser.role
        });

        const result = await postData(payload);
        hideModal();
        
        if (result && result.status === 'success') {
            showModal('Penyimpanan Berhasil', 'Absensi massal berhasil diperbarui.', 'success', 3000);
            
            // Refresh list after save
            const loadForm = document.getElementById('manual-attendance-form');
            if (loadForm) {
                 // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
                 setTimeout(() => loadForm.dispatchEvent(new Event('submit')), 50); 
            } else {
                 selectTab('absensi-siswa'); 
            }

        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan data absensi massal. Pastikan fungsi Apps Script sudah di-redeploy.', 'error', 5000);
        }
    }
    
    // --- Teacher Assessment Handlers ---

    function setupTeacherAssessmentListeners() {
        const loadForm = document.getElementById('assessment-load-form');
        const submitForm = document.getElementById('assessment-submit-form');
        const assessmentType = document.getElementById('assessment-type');
        const assessmentDateGroup = document.getElementById('assessment-date-group');
        const tableBody = document.getElementById('assessment-student-list-body');
        
        if (!loadForm || !submitForm) return;

        assessmentType.addEventListener('change', (e) => {
            if (e.target.value === 'harian') {
                assessmentDateGroup.classList.remove('hidden');
                document.getElementById('assessment-score-label').textContent = 'Nilai (0-100)';
            } else {
                assessmentDateGroup.classList.add('hidden');
                document.getElementById('assessment-score-label').textContent = 'Nilai Final (0-100)';
            }
        });

        loadForm.addEventListener('submit', handleLoadAssessmentList);
        submitForm.addEventListener('submit', handleSubmitAssessment);
        
        tableBody.removeEventListener('input', handleScoreInput);
        tableBody.addEventListener('input', handleScoreInput); 
    }

    async function handleLoadAssessmentList(e) {
        e.preventDefault();
        const type = document.getElementById('assessment-type').value;
        const kelas = document.getElementById('assessment-kelas').value;
        const jurusan = document.getElementById('assessment-jurusan').value;
        const date = (type === 'harian') ? document.getElementById('assessment-date').value : '';
        const messageDiv = document.getElementById('assessment-message');
        const submitForm = document.getElementById('assessment-submit-form');
        
        submitForm.classList.add('hidden'); messageDiv.classList.remove('hidden');
        // PERBAIKAN: Kontras dan Ukuran Loading Message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat daftar siswa dan data nilai...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        if (!kelas || !jurusan) {
            messageDiv.innerHTML = `<p class="font-semibold text-red-500">Harap pilih Kelas dan Jurusan yang valid.</p>`;
            return;
        }
        if (type === 'harian' && !date) {
            messageDiv.innerHTML = `<p class="font-semibold text-red-500">Harap masukkan Tanggal Penilaian Harian yang valid.</p>`;
            return;
        }

        const url = `${WEB_APP_URL}?action=getAssessmentList&kelas=${kelas}&jurusan=${jurusan}&type=${type}&date=${date}`;
        const result = await fetchData(url);
        
        let studentListWithScores = [];
        if (result && result.status === 'success' && result.students) {
            studentListWithScores = result.students;
        } else {
            const msg = result ? result.message : 'Gagal memuat data penilaian.';
            messageDiv.innerHTML = `<p class="font-semibold text-red-500">Error: ${msg}. Pastikan Sheet 'DATA NILAI' dan 'NILAI HARIAN' sudah benar dan skrip Apps Script sudah **REDEPLOY**.</p>`;
            return;
        }

        renderAssessmentTable(studentListWithScores, kelas, jurusan, type, date);

        if (studentListWithScores.length > 0) {
            messageDiv.classList.add('hidden');
            submitForm.classList.remove('hidden');
        } else {
            messageDiv.classList.remove('hidden');
            messageDiv.innerHTML = `<p class="font-semibold text-gray-700">Tidak ditemukan siswa di Kelas ${kelas} Jurusan ${jurusan}.</p>`;
        }
    }

    function renderAssessmentTable(students, kelas, jurusan, type, date) {
        const body = document.getElementById('assessment-student-list-body');
        body.innerHTML = '';
        
        students.forEach((student) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-white/10';
            
            // Tentukan nilai yang sudah ada
            const initialScore = (type === 'harian') ? student.scoreHarian : student.scoreFinal;
            
            row.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-white/90">
                    ${student.nisn}
                    <input type="hidden" name="nisn" value="${student.nisn}">
                    <input type="hidden" name="nama_${student.nisn}" value="${student.nama}">
                    <input type="hidden" name="kelas_${student.nisn}" value="${kelas}">
                    <input type="hidden" name="jurusan_${student.nisn}" value="${jurusan}">
                    <input type="hidden" name="type" value="${type}">
                    <input type="hidden" name="date" value="${date}">
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-white/90">${student.nama}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm">
                    <input type="number" name="score_${student.nisn}" min="0" max="100" value="${initialScore || ''}" placeholder="Nilai" class="w-24 text-center px-3 py-2 border border-white/30 rounded-md focus:ring-green-500 focus:border-green-500 glass-element">
                </td>
                <!-- FIX BUG 2: Tombol Simpan Individual -->
                <td class="px-4 py-4 whitespace-nowrap text-sm text-white/80 print-hidden">
                    <button type="button" onclick="handleSingleAssessmentUpdate('${student.nisn}')" 
                        class="bg-green-500 hover:bg-green-600 text-white text-xs font-semibold py-1 px-3 rounded-lg shadow-md transition duration-150 modern-hover">
                        <span data-lucide="save" class="w-4 h-4 mr-1"></span> Simpan
                    </button>
                </td>
            `;
            body.appendChild(row);
        });
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function handleSingleAssessmentUpdate(nisn) {
        const form = document.getElementById('assessment-submit-form');
        if (!form) return;

        const type = form.querySelector('input[name="type"]').value;
        const date = form.querySelector('input[name="date"]').value;
        const scoreInput = form.querySelector(`input[name="score_${nisn}"]`);
        const score = scoreInput.value.trim();
        
        if (score === '' || parseInt(score) < 0 || parseInt(score) > 100) {
             showModal('Validasi Nilai', `Nilai harus antara 0 dan 100.`, 'error', 3000);
             return;
        }

        const updates = [{ 
            nisn: nisn, 
            nama: form.querySelector(`input[name="nama_${nisn}"]`).value,
            kelas: form.querySelector(`input[name="kelas_${nisn}"]`).value,
            jurusan: form.querySelector(`input[name="jurusan_${nisn}"]`).value,
            score: score,
        }];
        
        showModal('Mengirim Data', `Menyimpan nilai ${type.toUpperCase()} untuk NISN ${nisn} secara individual...`, 'loading', 0);

        // API call to GAS to save the batch update with a single item
        const payload = new URLSearchParams({
            action: 'saveAssessmentBatch',
            type: type,
            date: date,
            updates: JSON.stringify(updates),
            submittedBy: currentUser.role
        });

        const result = await postData(payload);
        hideModal();
        
        if (result && result.status === 'success') {
            showModal('Penyimpanan Berhasil', `Nilai ${type.toUpperCase()} untuk NISN ${nisn} berhasil diperbarui.`, 'success', 3000);
            
            // Refresh list after save
            const loadForm = document.getElementById('assessment-load-form');
            if (loadForm) {
                 setTimeout(() => loadForm.dispatchEvent(new Event('submit')), 50);
            } else {
                 selectTab('penilaian');
            }

        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan data. Pastikan fungsi Apps Script sudah di-redeploy.', 'error', 5000);
        }
    }


    function handleScoreInput(e) {
        if (e.target.tagName.toLowerCase() === 'input' && e.target.name.startsWith('score_')) {
            const score = e.target.value.trim();
            
            // Validasi nilai
            if (score === '' || parseInt(score) < 0 || parseInt(score) > 100) {
                hideMiniPopup();
                return;
            }
            
            // Tampilkan pop up
            showMiniPopup('score', e.target, score);
        } else {
            hideMiniPopup();
        }
    }

    async function handleSubmitAssessment(e) {
        e.preventDefault();
        
        const form = e.target;
        const type = form.querySelector('input[name="type"]').value;
        const date = form.querySelector('input[name="date"]').value;
        const nisnInputs = form.querySelectorAll('input[name="nisn"]');
        const updates = [];
        
        nisnInputs.forEach(input => {
            const nisn = input.value;
            const scoreInput = form.querySelector(`input[name="score_${nisn}"]`);
            const score = scoreInput.value.trim();
            
            if (score !== '' && parseInt(score) >= 0 && parseInt(score) <= 100) {
                updates.push({ 
                    nisn: nisn, 
                    nama: form.querySelector(`input[name="nama_${nisn}"]`).value,
                    kelas: form.querySelector(`input[name="kelas_${nisn}"]`).value,
                    jurusan: form.querySelector(`input[name="jurusan_${nisn}"]`).value,
                    score: score,
                });
            } else if (score !== '') {
                 // Beri tahu user jika ada nilai tidak valid
                 showModal('Validasi Nilai', `Nilai siswa NISN ${nisn} (${score}) harus antara 0 dan 100. Data ini akan diabaikan.`, 'error', 5000);
            }
        });
        
        if (updates.length === 0) {
            showModal('Peringatan', 'Tidak ada nilai valid yang diisi untuk disimpan (Harus antara 0-100).', 'error', 3000);
            return;
        }
        
        showModal('Mengirim Data', 'Menyimpan nilai massal...', 'loading', 0);

        const payload = new URLSearchParams({
            action: 'saveAssessmentBatch',
            type: type,
            date: date,
            updates: JSON.stringify(updates),
            submittedBy: currentUser.role
        });

        const result = await postData(payload);
        hideModal();
        
        if (result && result.status === 'success') {
            showModal('Penyimpanan Berhasil', `Nilai ${type.toUpperCase()} massal berhasil diperbarui.`, 'success', 3000);
            
            // Refresh list setelah simpan
            const loadForm = document.getElementById('assessment-load-form');
            if (loadForm) {
                 setTimeout(() => loadForm.dispatchEvent(new Event('submit')), 50);
            } else {
                 selectTab('penilaian');
            }

        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan data. Pastikan fungsi Apps Script sudah di-redeploy.', 'error', 5000);
        }
    }
    
    // --- Admin Management Handlers ---
    
    async function loadAllStudents(searchTerm = '', kelas = '', jurusan = '') {
        const tableBody = document.getElementById('admin-student-list-body');
        const messageDiv = document.getElementById('admin-management-message');
        const updateForm = document.getElementById('admin-student-update-form');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const filteredCountSpan = document.getElementById('filtered-count');
        
        updateForm.classList.add('hidden');
        
        // Update global filter state
        currentFilterTerm = searchTerm;
        currentFilterKelas = kelas;
        currentFilterJurusan = jurusan;

        // Display loading message
        messageDiv.classList.remove('hidden');
        // PERBAIKAN: Kontras dan Ukuran Loading Message
        messageDiv.innerHTML = `<div class="flex flex-col justify-center items-center py-5">
            <div class="animate-spin mb-4">
                <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
            </div>
            <span class="text-white text-lg font-bold">Memuat data siswa...</span>
        </div>`;
        if (typeof lucide !== 'undefined') lucide.createIcons();

        if (allStudentsData.length === 0) {
            const url = `${WEB_APP_URL}?action=getAllStudents`;
            const result = await fetchData(url);
            
            if (result && result.status === 'success' && result.students) {
                allStudentsData = result.students;
            } else {
                console.error("Gagal memuat semua data siswa:", result);
                messageDiv.innerHTML = `<p class="font-semibold text-red-500">Gagal memuat semua data siswa. Pastikan fungsi 'getAllStudents' sudah di-redeploy di Apps Script.</p>`;
                if (bulkDeleteBtn) bulkDeleteBtn.setAttribute('disabled', 'disabled'); 
                filteredCountSpan.textContent = '0';
                return;
            }
        }

        const filteredStudents = allStudentsData.filter(student => {
            const studentNama = (student.nama || '').toLowerCase();
            const studentNisn = (student.nisn || '').toLowerCase();
            
            const matchesSearch = !searchTerm || studentNama.includes(searchTerm.toLowerCase()) || studentNisn.includes(searchTerm.toLowerCase());
            const matchesKelas = !kelas || student.kelas === kelas;
            const matchesJurusan = !jurusan || student.jurusan === jurusan;
            
            return matchesSearch && matchesKelas && matchesJurusan;
        });

        currentFilteredStudentCount = filteredStudents.length; // Save count

        renderAdminStudentTable(filteredStudents);
        
        if (filteredStudents.length > 0) {
            messageDiv.classList.add('hidden');
            updateForm.classList.remove('hidden');
            if (bulkDeleteBtn) bulkDeleteBtn.removeAttribute('disabled'); // Enable if items found
        } else if (allStudentsData.length > 0) {
            messageDiv.classList.remove('hidden');
            messageDiv.innerHTML = `<p class="font-semibold text-gray-700">Tidak ada data siswa yang cocok dengan filter Anda.</p>`;
            if (bulkDeleteBtn) bulkDeleteBtn.setAttribute('disabled', 'disabled'); // Disable if no items found
        } else {
             if (bulkDeleteBtn) bulkDeleteBtn.setAttribute('disabled', 'disabled'); // Disable if total data is 0
        }
        filteredCountSpan.textContent = currentFilteredStudentCount;
    }

    function renderAdminStudentTable(students) {
        const tableBody = document.getElementById('admin-student-list-body');
        if (!tableBody) return;

        let html = '';
        students.forEach((s, index) => {
            html += `
                <tr class="hover:bg-white/10">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white/90">
                        ${s.nisn || '-'}
                        <input type="hidden" name="nisn" value="${s.nisn || ''}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/90">
                        <input type="text" name="nama_${s.nisn}" value="${s.nama || ''}" class="w-full px-2 py-1 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">
                        <input type="text" name="kelas_${s.nisn}" value="${s.kelas || ''}" class="w-20 text-center px-2 py-1 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">
                        <input type="text" name="jurusan_${s.nisn}" value="${s.jurusan || ''}" class="w-28 text-center px-2 py-1 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80">
                        <!-- Perbaikan 1: Mengubah type menjadi text untuk mendukung karakter '-' -->
                        <input type="text" name="email_${s.nisn}" value="${s.email || ''}" 
                               pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                               class="w-full px-2 py-1 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80 print-hidden">
                        <input type="password" name="password_${s.nisn}" value="${s.password || ''}" placeholder="Kosongkan untuk tetap" class="w-full px-2 py-1 border rounded-md focus:ring-indigo-500 focus:border-indigo-500 glass-element">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-white/80 print-hidden">
                        <button type="button" onclick="handleDeleteStudent('${s.nisn}', '${s.nama}')" class="text-red-400 hover:text-red-300">
                            <span data-lucide="trash-2" class="w-4 h-4 inline-block"></span>
                        </button>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // NEW: Fungsi untuk menghapus siswa (menggunakan showConfirm)
    function handleDeleteStudent(nisn, nama) {
        showConfirm(
            'Konfirmasi Penghapusan',
            `Apakah Anda yakin ingin menghapus siswa ${nama} dengan NISN: ${nisn}? Aksi ini akan menghapus permanen data di Google Sheet dan tidak dapat dibatalkan.`,
            async () => {
                showModal('Menghapus Data', `Menghapus siswa NISN ${nisn}...`, 'loading', 0);
                
                const payload = new URLSearchParams({
                    action: 'deleteStudent',
                    nisn: nisn,
                });

                const result = await postData(payload);
                hideModal();
                if (result && result.status === 'success') {
                    showModal('Penghapusan Berhasil', result.message || `Siswa NISN ${nisn} berhasil dihapus.`, 'success', 3000);
                    // Clear cache dan reload tabel
                    allStudentsData = [];
                     // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
                    setTimeout(() => document.getElementById('admin-management-form').dispatchEvent(new Event('submit')), 50);
                } else {
                    showModal('Penghapusan Gagal', result ? result.message : 'Terjadi kesalahan saat menghapus data.', 'error', 5000);
                }
            }
        );
    }

    // NEW: Fungsi untuk menghapus siswa berdasarkan filter (menggunakan showConfirm)
    async function handleDeleteFilteredStudents() {
        if (currentFilteredStudentCount === 0) {
            showModal('Peringatan', 'Tidak ada siswa yang cocok dengan filter saat ini untuk dihapus.', 'error', 3000);
            return;
        }
        
        const filterSummary = `Cari: "${currentFilterTerm || 'SEMUA'}", Kelas: "${currentFilterKelas || 'SEMUA'}", Jurusan: "${currentFilterJurusan || 'SEMUA'}"`;
        
        showConfirm(
            'KONFIRMASI HAPUS MASSAL',
            `PERINGATAN: Anda akan menghapus **${currentFilteredStudentCount}** data siswa yang cocok dengan filter saat ini. (${filterSummary}). Aksi ini TIDAK dapat dibatalkan!`,
            async () => {
                showModal('Menghapus Data Massal', `Menghapus ${currentFilteredStudentCount} siswa berdasarkan filter... Proses ini mungkin memakan waktu.`, 'loading', 0);
                
                const payload = new URLSearchParams({
                    action: 'deleteStudentsByFilter', // New action for Apps Script
                    searchTerm: currentFilterTerm,
                    kelas: currentFilterKelas,
                    jurusan: currentFilterJurusan
                });

                const result = await postData(payload);
                hideModal();

                if (result && result.status === 'success') {
                    showModal('Penghapusan Berhasil', result.message || `${currentFilteredStudentCount} data siswa telah dihapus.`, 'success', 3000);
                    
                    // Clear local cache and reload table to reflect changes
                    allStudentsData = [];
                    // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
                    setTimeout(() => document.getElementById('admin-management-form').dispatchEvent(new Event('submit')), 50);
                } else {
                    showModal('Penghapusan Gagal', result ? result.message : 'Terjadi kesalahan saat menghapus data. Pastikan fungsi Apps Script sudah di-redeploy.', 'error', 5000);
                }
            }
        );
    }
    
    // NEW: Fungsi untuk menambah siswa baru
    async function handleAddNewStudent(e) {
        e.preventDefault();

        const form = e.target;
        const nisn = form.querySelector('#new-nisn').value.trim();
        const nama = form.querySelector('#new-nama').value.trim();
        const kelas = form.querySelector('#new-kelas').value.trim();
        const jurusan = form.querySelector('#new-jurusan').value.trim();
        const email = form.querySelector('#new-email').value.trim();
        const password = form.querySelector('#new-password').value.trim();

        // Basic validation
        if (!nisn || !nama || !kelas || !jurusan || !email || !password) {
            showModal('Validasi Gagal', 'Semua field wajib diisi.', 'error', 3000);
            return;
        }

        closeAddStudentModal();
        showModal('Menambah Data', `Menambahkan siswa baru: ${nama}...`, 'loading', 0);

        const payload = new URLSearchParams({
            action: 'addStudent',
            nisn, nama, kelas, jurusan, email, password
        });

        const result = await postData(payload);
        hideModal();

        if (result && result.status === 'success') {
            showModal('Penambahan Berhasil', result.message || `Siswa ${nama} berhasil ditambahkan.`, 'success', 3000);
            // Clear cache dan reload tabel
            allStudentsData = [];
            // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
            setTimeout(() => document.getElementById('admin-management-form').dispatchEvent(new Event('submit')), 50);
        } else {
            showModal('Penambahan Gagal', result ? result.message : 'Terjadi kesalahan saat menambahkan data. NISN mungkin sudah terdaftar.', 'error', 5000);
            openAddStudentModal(); // Buka kembali modal agar user bisa perbaiki
        }
    }


    function setupAdminManagementListeners() {
        // Load initial data upon tab selection
        loadAllStudents();

        const searchInput = document.getElementById('admin-search-student');
        const kelasSelect = document.getElementById('admin-filter-kelas');
        const jurusanSelect = document.getElementById('admin-filter-jurusan');
        const filterForm = document.getElementById('admin-management-form');
        const updateForm = document.getElementById('admin-student-update-form');

        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const searchTerm = searchInput.value.trim();
            const kelas = kelasSelect.value;
            const jurusan = jurusanSelect.value;
            
            document.getElementById('admin-student-list-body').innerHTML = '';
            document.getElementById('admin-management-message').classList.remove('hidden');
            // PERBAIKAN: Kontras dan Ukuran Loading Message
            document.getElementById('admin-management-message').innerHTML = `<div class="flex flex-col justify-center items-center py-5">
                <div class="animate-spin mb-4">
                    <span data-lucide="loader-circle" class="w-8 h-8 text-yellow-300"></span>
                </div>
                <span class="text-white text-lg font-bold">Memproses filter...</span>
            </div>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();

            loadAllStudents(searchTerm, kelas, jurusan);
        });
        
        updateForm.addEventListener('submit', handleSubmitStudentDataUpdate);

        // NEW: Listener untuk form tambah siswa
        document.getElementById('add-student-form').addEventListener('submit', handleAddNewStudent);
    }
    
    async function handleSubmitStudentDataUpdate(e) {
        e.preventDefault();
        
        const form = e.target;
        const nisnInputs = form.querySelectorAll('input[name="nisn"]');
        const updates = [];
        
        nisnInputs.forEach(input => {
            const nisn = input.value;
            
            // Get values from editable fields
            const nama = form.querySelector(`input[name="nama_${nisn}"]`).value.trim();
            const kelas = form.querySelector(`input[name="kelas_${nisn}"]`).value.trim();
            const jurusan = form.querySelector(`input[name="jurusan_${nisn}"]`).value.trim();
            const email = form.querySelector(`input[name="email_${nisn}"]`).value.trim();
            const password = form.querySelector(`input[name="password_${nisn}"]`).value.trim();

            updates.push({ 
                nisn, nama, kelas, jurusan, email, password
            });
        });
        
        if (updates.length === 0) return;
        
        showModal('Mengirim Data', 'Menyimpan perubahan data siswa massal...', 'loading', 0);

        const payload = new URLSearchParams({
            action: 'updateStudentDataBatch',
            updates: JSON.stringify(updates),
        });

        const result = await postData(payload);
        hideModal();
        
        if (result && result.status === 'success') {
            showModal('Penyimpanan Berhasil', result.message || 'Data siswa berhasil diperbarui.', 'success', 3000);
            
            // Clear local cache and reload table with filters applied
            allStudentsData = []; 
            const filterForm = document.getElementById('admin-management-form');
            if (filterForm) {
                 // FIX: Tambahkan delay 50ms untuk sinkronisasi data Apps Script
                 setTimeout(() => filterForm.dispatchEvent(new Event('submit')), 50);
            } else {
                 selectTab('manajemen');
            }

        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan data. Pastikan fungsi Apps Script sudah di-redeploy.', 'error', 5000);
        }
    }

    // --- Admin Recap Listener (Detail Harian) ---

    function setupAdminRecapListeners() {
        const form = document.getElementById('admin-recap-form');
        if (!form) return;
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const kelas = document.getElementById('admin-rekap-kelas').value;
            const jurusan = document.getElementById('admin-rekap-jurusan').value;
            const periode = document.getElementById('admin-rekap-periode').value;

            displayRecap(kelas, jurusan, periode, 'admin-recap-results', 'admin-recap-message', 'admin-recap-table-body', 'admin-recap-chart', 'getRecap');
        });
    }
    
    // --- Admin Configuration Handlers (NEW) ---

    function setupAdminConfigurationListeners() {
        const configForm = document.getElementById('admin-config-form');
        if (!configForm) return;

        configForm.addEventListener('submit', handleAdminConfigSubmission);
        document.getElementById('apply-base64-btn').addEventListener('click', handleBase64LogoApplication);
    }
    
    function handleBase64LogoApplication() {
        const base64Input = document.getElementById('config-logo-base64');
        const urlInput = document.getElementById('config-logo-url');
        const base64Value = base64Input.value.trim();

        if (base64Value.startsWith('data:image/')) {
            urlInput.value = base64Value; // Set the URL input to the base64 string
            showModal('Base64 Diterapkan', 'URL logo telah diperbarui dengan data Base64. Jangan lupa tekan "Simpan Konfigurasi" di bawah!', 'info', 4000);
            base64Input.value = '';
        } else if (base64Value !== '') {
            showModal('Format Invalid', 'Input harus berupa string Base64 yang valid (dimulai dengan data:image/).', 'error', 4000);
        } else {
            showModal('Peringatan', 'Input Base64 kosong.', 'info', 2000);
        }
    }
    
    async function handleAdminConfigSubmission(e) {
        e.preventDefault();
        
        const schoolName = document.getElementById('config-school-name').value.trim();
        const logoUrl = document.getElementById('config-logo-url').value.trim();

        if (!schoolName || !logoUrl) {
            showModal('Validasi', 'Nama Sekolah dan URL Logo harus diisi.', 'error', 3000);
            return;
        }

        showModal('Menyimpan Konfigurasi', 'Mengirim data konfigurasi ke server...', 'loading', 0);

        const payload = new URLSearchParams({
            action: 'saveAppConfiguration',
            schoolName: schoolName,
            logoUrl: logoUrl,
        });

        const result = await postData(payload);
        hideModal();

        if (result && result.status === 'success') {
            // Update local state and UI
            APP_CONFIG.SCHOOL_NAME = schoolName;
            APP_CONFIG.LOGO_URL = logoUrl;
            updateHeaderDisplay();
            
            showModal('Konfigurasi Berhasil', 'Nama sekolah dan URL logo berhasil diperbarui.', 'success', 3000);
        } else {
            showModal('Penyimpanan Gagal', result ? result.message : 'Terjadi kesalahan saat menyimpan konfigurasi. Pastikan fungsi Apps Script **saveAppConfiguration** sudah di-redeploy.', 'error', 5000);
        }
    }


    // ====================================================================
    // --- FINAL INITIALIZATION BLOCK ---
    // ====================================================================
    
    // NEW: Login Form Handler moved here
    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentRole) {
            document.getElementById('login-message').innerText = 'Harap pilih peran Anda terlebih dahulu.';
            document.getElementById('login-message').classList.remove('hidden');
            return;
        }
        
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const messageEl = document.getElementById('login-message');
        messageEl.classList.add('hidden');

        showModal('Otentikasi', 'Memverifikasi kredensial...', 'loading');

        const url = `${WEB_APP_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&role=${currentRole}`;
        const result = await fetchData(url);
        
        hideModal();

        if (result && result.status === 'success') {
            currentUser = result.user;
            initializeDashboard();
        } else {
            messageEl.innerText = result ? result.message : 'Login gagal. Coba lagi.';
            messageEl.classList.remove('hidden');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderDisplay();
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        renderRoleSelection();

        const loaded = loadAppState();
        if (!loaded) {
            // Biarkan halaman login/pilihan peran ditampilkan
        }
    });
    
    setInterval(updateTime, 1000);
    
    // Helper function for Export button (Perbaikan: Mengganti alert dengan showModal)
    function handleExport(type) {
        if (type === 'print') {
            window.print();
        } else if (type === 'xlsx') {
             // Bagian ini sudah dihapus dari UI, diganti dengan Database
        }
    }
    
    // Helper function to open Google Sheet (Perbaikan 2: Digunakan oleh tombol Database)
    function openGoogleSheetLink() {
        if (GOOGLE_SHEET_URL) {
            window.open(GOOGLE_SHEET_URL, '_blank');
        } else {
            showModal('Konfigurasi Belum Selesai', 'URL Google Sheet belum dikonfigurasi. Harap periksa variabel GOOGLE_SHEET_URL di baris 33.', 'error', 5000);
        }
    }

</script>
</body>
</html>


