/**
 * Google Apps Script (GAS) untuk menghubungkan aplikasi HTML Absensi
 * dengan Google Spreadsheet sebagai database.
 */

// GANTI ID INI DENGAN ID SPREADSHEET ANDA.
const SPREADSHEET_ID = '1F72NOuTyeDYePeu5nLk_oLrvjecx-5iLCxj3cO57l1Y'; 
// !!! PENTING: GANTI DENGAN ID FOLDER GOOGLE DRIVE UNTUK MENYIMPAN FOTO !!!
const DRIVE_PHOTO_FOLDER_ID = '1G5OmlRThcCvJG7olROVdq05HBMIHq0av'; 

// Nama-nama Sheet (disesuaikan dengan screenshot: 'DATA SISWA' dan 'DATA ABSEN')
const STUDENT_SHEET_NAME = 'DATA SISWA';
const ATTENDANCE_SHEET_NAME = 'DATA ABSEN';
const TEACHER_SHEET_NAME = 'GURU';
const ADMIN_SHEET_NAME = 'ADMIN';
const ASSESSMENT_FINAL_SHEET_NAME = 'DATA NILAI';
const ASSESSMENT_HARIAN_SHEET_NAME = 'NILAI HARIAN';


// --- MAIN HANDLERS ---

function doGet(e) {
    if (!e || !e.parameter || !e.parameter.action) {
        return createJsonResponse({ status: 'error', message: 'Error: Aksi tidak valid atau parameter tidak ditemukan.' });
    }

    const action = e.parameter.action;
    Logger.log(`Aksi diterima: ${action}`);

    try {
        if (action === 'login') {
            return handleLogin(e.parameter);
        } else if (action === 'getStudentStatus') {
            // UPDATED: Menambahkan parameter photo jika ada
            return getStudentAttendanceStatus(e.parameter.nisn, e.parameter.date);
        } else if (action === 'getRecap') {
            return getRecapData(e.parameter);
        } else if (action === 'getStudentHistory') { 
            return getStudentHistory(e.parameter); 
        } else if (action === 'getComparisonData') { 
            return getComparisonData(e.parameter);
        } else if (action === 'getStudentListWithStatus') { 
            // PERBAIKAN: Menambahkan handler yang hilang untuk aksi ini
            return getStudentListWithStatus(e.parameter);
        } else if (action === 'getAllStudents') { 
            return getAllStudents();
        } else if (action === 'getAssessmentList') {
            return getAssessmentList(e.parameter);
        } else if (action === 'getTotalRecap') { 
            return getTotalRecap(e.parameter); 
        }

        return createJsonResponse({ status: 'error', message: 'Error: Aksi tidak dikenali.' });

    } catch (error) {
        Logger.log(`Error dalam doGet(${action}): ${error.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server: ${error.message}` });
    }
}

function doPost(e) {
    if (!e || !e.parameter || !e.parameter.action) {
        return createResponse('Error: Aksi tidak valid atau parameter tidak ditemukan.');
    }
    
    const action = e.parameter.action;

    try {
        if (action === 'saveAttendance') {
            // UPDATED: Menangani params dari aplikasi web
            return saveAttendance(e.parameter);
        } else if (action === 'handleManualAttendanceUpdate') { 
            return handleManualAttendanceUpdate(e.parameter);
        } else if (action === 'saveAssessmentBatch') {
            return saveAssessmentBatch(e.parameter);
        } else if (action === 'updateStudentDataBatch') { 
            return updateStudentDataBatch(e.parameter);
        } else if (action === 'addStudent') { 
            return addStudent(e.parameter);
        } else if (action === 'deleteStudent') { 
            return deleteStudent(e.parameter);
        } else if (action === 'deleteStudentsByFilter') { 
            return deleteStudentsByFilter(e.parameter);
        } else if (action === 'saveAppConfiguration') { 
            // Tambahkan handler jika Anda telah mengimplementasikan konfigurasi
            return saveAppConfiguration(e.parameter); 
        }
        return createResponse('Error: Aksi POST tidak dikenali.');
        
    } catch (error) {
        Logger.log(`Error dalam doPost(${action}): ${error.message}`);
        return createResponse(`Error: Gagal memproses POST. Pesan: ${error.message}`);
    }
}

// --- UTILITY FUNCTIONS ---

function createJsonResponse(data) {
    return ContentService
        .createTextOutput(JSON.stringify(data))
        .setMimeType(ContentService.MimeType.JSON);
}

function createResponse(text) {
    return ContentService
        .createTextOutput(text)
        .setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Mengambil data dari Sheet dan memformat kolom 'DATE' dan 'TIME'
 * menjadi string yang ketat menggunakan Zona Waktu Spreadsheet.
 */
function getSheetData(sheetName) {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
        throw new Error(`Sheet tidak ditemukan: ${sheetName}. Harap periksa nama Sheet di Google Spreadsheet Anda.`);
    }
    
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    if (lastRow < 1 || lastCol < 1) return { headers: [], data: [] };

    const range = sheet.getRange(1, 1, lastRow, lastCol);
    const values = range.getValues();
    if (values.length <= 1) return { headers: [], data: [] };
    
    const headers = values[0].map(h => h.toString().trim().toUpperCase()); 
    const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
    
    const data = values.slice(1).map(row => {
        const obj = {};
        headers.forEach((header, index) => {
            let value = row[index];
            
            // NEW EFFICIENT DATE HANDLING
            if (value instanceof Date) {
                if (header.includes('DATE') || header.includes('TANGGAL')) {
                    value = Utilities.formatDate(value, spreadsheetTimeZone, 'yyyy-MM-dd');
                } else if (header.includes('TIME') || header.includes('WAKTU')) {
                    value = Utilities.formatDate(value, spreadsheetTimeZone, 'HH:mm:ss');
                } else {
                    // Default: Date time format (e.g., for general timestamps)
                    value = Utilities.formatDate(value, spreadsheetTimeZone, 'yyyy-MM-dd HH:mm:ss');
                }
            }
            
            obj[headers[index]] = (value === null || value === undefined || value === '') ? '' : value.toString().trim();
        });
        return obj;
    });
    return { headers, data };
}

/**
 * Helper untuk memfilter data absensi berdasarkan periode.
 * PERBAIKAN: Mengimplementasikan filter tanggal yang sesungguhnya untuk periode Mingguan/Bulanan.
 */
function filterAttendanceByPeriod(data, periode) {
    const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
    const today = new Date();
    const todayStr = Utilities.formatDate(today, spreadsheetTimeZone, 'yyyy-MM-dd');
    
    let startDate = new Date(today);
    let endDate = new Date(today);
    
    // Reset waktu ke awal hari untuk komparasi
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);

    if (periode === 'harian') {
        // Biarkan start/end date sebagai hari ini
    } else if (periode === 'mingguan') {
        // Minggu: 7 hari terakhir
        startDate.setDate(today.getDate() - 7);
    } else if (periode === 'bulanan') {
        // Bulanan: 30 hari terakhir
        startDate.setDate(today.getDate() - 30);
    } else {
        // Jika periode tidak didefinisikan (ambil semua data)
        return data; 
    }
    
    const formattedStartDate = Utilities.formatDate(startDate, spreadsheetTimeZone, 'yyyy-MM-dd');
    const formattedEndDate = Utilities.formatDate(endDate, spreadsheetTimeZone, 'yyyy-MM-dd');

    return data.filter(row => {
        const rowDateStr = row['DATE'];
        if (!rowDateStr) return false;
        
        // Cek apakah tanggal berada dalam rentang
        return rowDateStr >= formattedStartDate && rowDateStr <= formattedEndDate;
    });
}

/**
 * Helper untuk mendapatkan rentang tanggal (start dan end) berdasarkan periode yang dipilih.
 * Digunakan untuk Rekap Total.
 */
function getFilterDates(params) {
    const { periode, startDate: start, endDate: end } = params;
    const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
    const today = new Date();
    
    let startDate = new Date(today);
    let endDate = new Date(today);
    
    // Reset waktu ke awal hari untuk memastikan inklusifitas tanggal
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);

    if (periode === 'custom' && start && end) {
        startDate = new Date(start);
        endDate = new Date(end);
    } else if (periode === '1bulan') {
        startDate.setMonth(today.getMonth() - 1);
    } else if (periode === '3bulan') {
        startDate.setMonth(today.getMonth() - 3);
    } else if (periode === '6bulan') {
        startDate.setMonth(today.getMonth() - 6);
    } else if (periode === '12bulan') {
        startDate.setFullYear(today.getFullYear() - 1);
    } else {
        // Default ke 3 bulan terakhir jika periode tidak dikenali (jika frontend tidak memfilter)
        startDate.setMonth(today.getMonth() - 3);
    }
    
    // Format dates to YYYY-MM-DD strings for comparison
    const formattedStartDate = Utilities.formatDate(startDate, spreadsheetTimeZone, 'yyyy-MM-dd');
    const formattedEndDate = Utilities.formatDate(endDate, spreadsheetTimeZone, 'yyyy-MM-dd');

    return { startDate: formattedStartDate, endDate: formattedEndDate };
}

/**
 * Helper untuk memfilter data absensi berdasarkan rentang tanggal string (YYYY-MM-DD).
 */
function filterAttendanceByDateRange(data, formattedStartDate, formattedEndDate) {
    if (!formattedStartDate || !formattedEndDate) return data;
    
    return data.filter(row => {
        const rowDateStr = row['DATE'];
        if (!rowDateStr) return false;

        return rowDateStr >= formattedStartDate && rowDateStr <= formattedEndDate;
    });
}

/**
 * Helper untuk memfilter data absensi berdasarkan otoritas guru/admin (wewenang) 
 * dan mengembalikan peta data siswa.
 */
function filterByAuthorityAndGetStudentMap(params) {
    const { role, nip } = params;
    const { data: allAttendance } = getSheetData(ATTENDANCE_SHEET_NAME);
    const { data: allStudents, headers: studentHeaders } = getSheetData(STUDENT_SHEET_NAME);

    let filteredAttendance = allAttendance;
    let filteredStudents = allStudents;
    
    // Buat map data siswa untuk pencarian cepat
    const studentMap = {};
    allStudents.forEach(student => {
        if (student.NISN) {
            studentMap[student.NISN.toString().trim()] = student;
        }
    });

    // Authority Filtering (Wewenang)
    if (role === 'teacher' || role === 'admin') {
        const sheetName = role === 'teacher' ? TEACHER_SHEET_NAME : ADMIN_SHEET_NAME;
        const { data: userData, headers: userHeaders } = getSheetData(sheetName);
        const user = userData.find(row => row['NIP'] && row['NIP'].toString().trim() === nip.toString().trim());

        if (user) {
            const hasKelasAjar = userHeaders.includes('KELAS AJAR');
            const hasJurusanAjar = userHeaders.includes('JURUSAN AJAR');
            
            const ajarKelasStr = hasKelasAjar ? (user['KELAS AJAR'] || '') : '';
            const ajarJurusanStr = hasJurusanAjar ? (user['JURUSAN AJAR'] || '') : '';
            
            const ajarKelas = ajarKelasStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
            const ajarJurusan = ajarJurusanStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
            
            // Filter attendance data based on teaching authority
            if (ajarKelas.length > 0 || ajarJurusan.length > 0) {
                filteredAttendance = filteredAttendance.filter(row => {
                    const rowKelas = row['KELAS'] ? row['KELAS'].toString().trim() : '';
                    const rowJurusan = row['JURUSAN'] ? row['JURUSAN'].toString().trim() : '';
                    
                    const isKelasAjar = ajarKelas.length === 0 || ajarKelas.includes(rowKelas);
                    const isJurusanAjar = ajarJurusan.length === 0 || ajarJurusan.includes(rowJurusan);

                    return isKelasAjar && isJurusanAjar;
                });
                
                // Filter student data based on teaching authority (important for demographic views)
                filteredStudents = filteredStudents.filter(row => {
                    const rowKelas = row['KELAS'] ? row['KELAS'].toString().trim() : '';
                    const rowJurusan = row['JURUSAN'] ? row['JURUSAN'].toString().trim() : '';
                    
                    const isKelasAjar = ajarKelas.length === 0 || ajarKelas.includes(rowKelas);
                    const isJurusanAjar = ajarJurusan.length === 0 || ajarJurusan.includes(rowJurusan);

                    return isKelasAjar && isJurusanAjar;
                });
            }
        }
    }
    
    // Apply frontend filters (kelas, jurusan) to both attendance and student lists
    const { kelas, jurusan } = params;
    if (kelas) {
        filteredAttendance = filteredAttendance.filter(row => row['KELAS'] && row['KELAS'].toString().trim() === kelas.toString().trim());
        filteredStudents = filteredStudents.filter(row => row['KELAS'] && row['KELAS'].toString().trim() === kelas.toString().trim());
    }
    if (jurusan) {
        filteredAttendance = filteredAttendance.filter(row => row['JURUSAN'] && row['JURUSAN'].toString().trim() === jurusan.toString().trim());
        filteredStudents = filteredStudents.filter(row => row['JURUSAN'] && row['JURUSAN'].toString().trim() === jurusan.toString().trim());
    }
    
    return { 
        filteredData: filteredAttendance, 
        filteredStudents: filteredStudents,
        studentMap: studentMap 
    };
}


// --- LOGIN HANDLER ---

function handleLogin(params) {
    const username = params.username;
    const password = params.password;
    const role = params.role; 

    let sheetName = '';
    let usernameHeader = '';

    if (role === 'student') {
        sheetName = STUDENT_SHEET_NAME;
        usernameHeader = 'NISN';
    } else if (role === 'teacher') {
        sheetName = TEACHER_SHEET_NAME;
        usernameHeader = 'NIP'; 
    } else if (role === 'admin') {
        sheetName = ADMIN_SHEET_NAME;
        usernameHeader = 'NIP'; 
    } else {
        return createJsonResponse({ status: 'error', message: 'Error: Peran tidak valid.' });
    }

    try {
        const { headers, data } = getSheetData(sheetName);
        
        const requiredHeaders = ['PASSWORD', usernameHeader.toUpperCase(), 'NAMA LENGKAP']; 
        if (role === 'student') {
            requiredHeaders.push('KELAS', 'JURUSAN');
        }
        // Check if optional columns exist before requiring them
        const hasKelasAjar = headers.includes('KELAS AJAR');
        const hasJurusanAjar = headers.includes('JURUSAN AJAR');


        for (const header of requiredHeaders) {
            if (headers.indexOf(header) === -1) {
                // Ini untuk memberikan pesan error yang jelas jika kolom wajib tidak ada
                return createJsonResponse({ status: 'error', message: `Error: Kolom wajib (${header}) tidak ditemukan di sheet ${sheetName}.` });
            }
        }

        const userRecord = data.find(row => 
            row[usernameHeader.toUpperCase()].toString().trim() === username.toString().trim() && 
            row['PASSWORD'].toString().trim() === password.toString().trim()
        );

        if (userRecord) {
            const user = {
                role: role,
                nama: userRecord['NAMA LENGKAP'] || 'Pengguna',
                kelas: userRecord['KELAS'] || '',
                jurusan: userRecord['JURUSAN'] || '',
                email: userRecord['EMAIL'] || '',
            };

            if (role === 'student') {
                user.nisn = userRecord['NISN'];
            } else {
                user.nip = userRecord['NIP'];
                user.kelasAjar = hasKelasAjar ? (userRecord['KELAS AJAR'] ? userRecord['KELAS AJAR'].toString().split(',').map(s => s.trim()).filter(s => s.length > 0) : []) : [];
                user.jurusanAjar = hasJurusanAjar ? (userRecord['JURUSAN AJAR'] ? userRecord['JURUSAN AJAR'].toString().split(',').map(s => s.trim()).filter(s => s.length > 0) : []) : [];
            }

            return createJsonResponse({ status: 'success', user: user });
        } else {
            return createJsonResponse({ status: 'error', message: `${usernameHeader} atau Kata Sandi salah.` });
        }

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat login: ${e.message}` });
    }
}


// --- ATTENDANCE STATUS CHECK ---

function getStudentAttendanceStatus(nisn, date) {
    try {
        const { data } = getSheetData(ATTENDANCE_SHEET_NAME);
        
        // UPDATED: Menambahkan kolom PHOTO
        const record = data.find(row => 
            row['NISN'] && row['NISN'].toString().trim() === nisn.toString().trim() && 
            (row['DATE'] && row['DATE'].toString().trim() === date.toString().trim())
        );

        if (record) {
            return createJsonResponse({ 
                status: 'success', 
                record: {
                    date: record['DATE'],
                    time: record['TIME'],
                    status: record['STATUS'],
                    keterangan: record['KETERANGAN'],
                    photo: record['PHOTO URL'] || '' // NEW: Mengambil URL Foto
                } 
            });
        } else {
            return createJsonResponse({ status: 'success', record: null });
        }

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat cek status: ${e.message}` });
    }
}


// --- SAVE ATTENDANCE ---

function saveAttendance(params) {
    try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(ATTENDANCE_SHEET_NAME);
        
        if (!sheet) {
            return createResponse(`Error: Sheet absensi (${ATTENDANCE_SHEET_NAME}) tidak ditemukan.`);
        }

        const now = new Date();
        const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();

        const date = Utilities.formatDate(now, spreadsheetTimeZone, 'yyyy-MM-dd');
        const time = Utilities.formatDate(now, spreadsheetTimeZone, 'HH:mm:ss');
        
        // Pastikan keterangan tidak null
        const keterangan = params.keterangan || '-';
        const photoData = params.photo; // NEW: Ambil data foto Base64
        let photoUrl = '';

        if (photoData && photoData.length > 0) {
            if (DRIVE_PHOTO_FOLDER_ID === 'YOUR_GOOGLE_DRIVE_FOLDER_ID' || !DRIVE_PHOTO_FOLDER_ID) {
                // WARNING: Tidak bisa menyimpan foto jika ID folder belum diset
                 Logger.log("WARNING: DRIVE_PHOTO_FOLDER_ID belum diatur.");
            } else {
                photoUrl = savePhotoToDrive(photoData, params.nisn); // Simpan foto dan dapatkan URL
            }
        }
        
        // Pastikan kolom 'PHOTO URL' ada di header
        const { headers } = getSheetData(ATTENDANCE_SHEET_NAME);
        
        const headerMap = {
            'DATE': date,
            'TIME': params.status === 'Hadir' ? time : '', // TIME hanya diisi jika HADIR
            'NISN': params.nisn,
            'NAMA LENGKAP': params.nama,
            'KELAS': params.kelas,
            'JURUSAN': params.jurusan,
            'STATUS': params.status,
            'KETERANGAN': keterangan,
            'SUBMITTED BY': params.submittedBy,
            'PHOTO URL': photoUrl // NEW: Tambahkan URL foto
        };
        
        // Map data to the correct column order
        const newRow = headers.map(header => headerMap[header] || '');

        sheet.appendRow(newRow);

        return createResponse('Absensi berhasil disimpan.');

    } catch (e) {
        return createResponse(`Error: Gagal menyimpan data absensi. Pesan: ${e.message}`);
    }
}

/**
 * NEW FUNCTION: Menyimpan Base64 photo ke Google Drive dan mengembalikan URL.
 */
function savePhotoToDrive(data, nisn) {
    try {
        const base64Content = data.split(',')[1];
        
        // Menggunakan nama file unik: NISN_Tanggal_Waktu.jpg
        const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
        const timestamp = Utilities.formatDate(new Date(), spreadsheetTimeZone, 'yyyyMMdd_HHmmss');
        const fileName = `${nisn}_${timestamp}.jpg`;

        var blob = Utilities.newBlob(Utilities.base64Decode(base64Content), 'image/jpeg', fileName);
        
        var folder;
        try {
             folder = DriveApp.getFolderById(DRIVE_PHOTO_FOLDER_ID);
        } catch (e) {
            // Jika ID folder Drive salah
            Logger.log(`Error mengakses folder Drive: ${e.message}`);
            return "Error Drive ID";
        }
        
        var file = folder.createFile(blob);
        
        // Penting: Set izin agar URL dapat diakses oleh semua orang (untuk ditampilkan di web)
        file.setSharing(DriveApp.Access.ANYONE, DriveApp.Permission.VIEW);
        
        return file.getUrl();
        
    } catch (e) {
        Logger.log(`Error menyimpan foto ke Drive: ${e.message}`);
        throw new Error(`Gagal menyimpan foto ke Drive. Pesan: ${e.message}`);
    }
}


// --- STUDENT HISTORY ---

function getStudentHistory(params) {
    const nisn = params.nisn;
    if (!nisn) {
        return createJsonResponse({ status: 'error', message: 'Error: NISN diperlukan untuk melihat riwayat.' });
    }
    
    try {
        const { data } = getSheetData(ATTENDANCE_SHEET_NAME);

        const historyData = data.filter(row => row['NISN'] && row['NISN'].toString().trim() === nisn.toString().trim());

        const records = historyData.map(row => ({
            date: row['DATE'],
            time: row['TIME'],
            nisn: row['NISN'],
            nama: row['NAMA LENGKAP'], 
            kelas: row['KELAS'],
            jurusan: row['JURUSAN'],
            status: row['STATUS'],
            keterangan: row['KETERANGAN'],
            photo: row['PHOTO URL'] || '' // NEW: Sertakan URL Foto
        }));

        records.sort((a, b) => {
            const dateTimeA = `${a.date} ${a.time}`;
            const dateTimeB = `${b.date} ${b.time}`;
            if (dateTimeA > dateTimeB) return -1;
            if (dateTimeA < dateTimeB) return 1;
            return 0;
        });

        return createJsonResponse({ status: 'success', records: records });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat mengambil riwayat: ${e.message}` });
    }
}

// --- RECAP DATA (DETAIL HARIAN) ---

function getRecapData(params) {
    try {
        const { data } = getSheetData(ATTENDANCE_SHEET_NAME);
        const { kelas, jurusan, periode, role, nip } = params;

        // 1. Filter Wewenang & Kelas/Jurusan
        const { filteredData, filteredStudents } = filterByAuthorityAndGetStudentMap(params);
        
        // 2. Filter Periode (Mingguan/Bulanan/Harian)
        // PERBAIKAN KRITIS: Gunakan fungsi filterAttendanceByPeriod yang baru
        let recordsByPeriod = filterAttendanceByPeriod(filteredData, periode);

        // 3. Hitung Summary Berdasarkan recordsByPeriod
        const summary = { 'Hadir': 0, 'Izin': 0, 'Sakit': 0, 'Alpha': 0, 'Total': 0 };
        const statusColumns = ['Hadir', 'Izin', 'Sakit', 'Alpha'];

        // Mengelompokkan berdasarkan NISN untuk menghitung total siswa yang unik (yang memiliki record di periode ini)
        const uniqueNisn = new Set();
        
        recordsByPeriod.forEach(record => {
            const status = record['STATUS'];
            if (statusColumns.includes(status)) {
                summary[status] = (summary[status] || 0) + 1;
            }
            uniqueNisn.add(record.NISN);
        });
        
        // Total Siswa (count unik dari NISN yang memiliki record absensi di periode ini)
        summary.Total = uniqueNisn.size;
        
        // 4. Transformasi dan Sorting untuk Front-end
        const records = recordsByPeriod.map(row => ({
            date: row['DATE'],
            time: row['TIME'],
            nisn: row['NISN'],
            nama: row['NAMA LENGKAP'], 
            kelas: row['KELAS'],
            jurusan: row['JURUSAN'],
            status: row['STATUS'],
            keterangan: row['KETERANGAN'],
            photo: row['PHOTO URL'] || '' 
        }));
        
        records.sort((a, b) => {
            const dateTimeA = `${a.date} ${a.time}`;
            const dateTimeB = `${b.date} ${b.time}`;
            if (dateTimeA > dateTimeB) return -1;
            if (dateTimeA < dateTimeB) return 1;
            return 0;
        });


        return createJsonResponse({ 
            status: 'success', 
            records: records, 
            summary: summary // Mengembalikan summary yang dihitung dengan benar
        });

    } catch (e) {
        Logger.log(`Error getRecapData: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat mengambil rekap: ${e.message}` });
    }
}

// --- NEW: RECAP DATA (TOTAL SUMMARY) ---

function getTotalRecap(params) {
    try {
        // 1. Tentukan rentang tanggal
        const { startDate, endDate } = getFilterDates(params);

        // 2. Filter data absensi berdasarkan wewenang dan filter kelas/jurusan
        // Perlu mendapatkan filteredStudents juga untuk list siswa lengkap
        const { filteredData: filteredAttendance, filteredStudents, studentMap } = filterByAuthorityAndGetStudentMap(params);

        // 3. Filter data berdasarkan rentang tanggal
        let attendanceByDate = filterAttendanceByDateRange(filteredAttendance, startDate, endDate);
        
        // 4. Agregasi berdasarkan NISN dan status
        const summaryMap = {};
        attendanceByDate.forEach(row => {
            const nisn = row.NISN.toString().trim();
            const status = row.STATUS || 'Alpha'; 

            // Hanya agregasi status yang valid (Hadir, Izin, Sakit, Alpha)
            if (['Hadir', 'Izin', 'Sakit', 'Alpha'].includes(status)) {
                if (!summaryMap[nisn]) {
                    summaryMap[nisn] = { Hadir: 0, Izin: 0, Sakit: 0, Alpha: 0 };
                }
                summaryMap[nisn][status]++;
            }
        });

        // 5. Gabungkan hasil agregasi dengan *semua* siswa yang relevan (walaupun tidak ada record)
        const finalSummary = filteredStudents.map(siswa => {
            const nisn = siswa.NISN.toString().trim();
            const attendance = summaryMap[nisn] || { Hadir: 0, Izin: 0, Sakit: 0, Alpha: 0 };
            
            return {
                nisn: nisn,
                nama: siswa['NAMA LENGKAP'],
                kelas: siswa['KELAS'],
                jurusan: siswa['JURUSAN'],
                Hadir: attendance.Hadir,
                Izin: attendance.Izin,
                Sakit: attendance.Sakit,
                Alpha: attendance.Alpha,
            };
        }).sort((a, b) => {
            // Sortir berdasarkan Kelas, lalu Nama
            if (a.kelas !== b.kelas) {
                return a.kelas.localeCompare(b.kelas);
            }
            return a.nama.localeCompare(b.nama);
        });
        
        return createJsonResponse({ status: 'success', summary: finalSummary });

    } catch (e) {
        Logger.log(`Error getTotalRecap: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat mengambil rekap total: ${e.message}` });
    }
}

// --- COMPARISON DATA ---

function getComparisonData(params) {
    // Fungsi ini sekarang mengembalikan 2 jenis data:
    // 1. Demografi: Jumlah siswa total per kelas/jurusan (untuk chart awal).
    // 2. Kehadiran: Persentase status kehadiran (Hadir, Izin, Sakit, Alpha) per kelas/jurusan.
    
    const { role, nip, filterType, gradeLevel } = params; // Tambahkan gradeLevel di destructing
    
    try {
        const { data: allAttendance, headers: attendanceHeaders } = getSheetData(ATTENDANCE_SHEET_NAME);
        const { data: allStudents, headers: studentHeaders } = getSheetData(STUDENT_SHEET_NAME);

        // 1. Filter Wewenang & Kelas/Jurusan Ajar
        const { filteredData: initialAttendance, filteredStudents: initialStudents } = filterByAuthorityAndGetStudentMap(params);
        let filteredAttendance = initialAttendance;
        let filteredStudents = initialStudents;
        
        const hasStudentKelas = studentHeaders.includes('KELAS');
        const hasStudentJurusan = studentHeaders.includes('JURUSAN');
        
        if (!hasStudentKelas || !hasStudentJurusan) {
             throw new Error('Sheet DATA SISWA harus memiliki kolom KELAS dan JURUSAN.');
        }

        // --- NEW FIX: Apply Grade Level filter if filterType is 'major' and gradeLevel is set ---
        // Jika kriteria adalah Jurusan & Tingkatan, terapkan filter Tingkatan Kelas pada data
        if (filterType === 'major' && gradeLevel && gradeLevel.trim() !== '') {
            const gradeFilter = gradeLevel.trim();
            
            // Terapkan filter ke daftar siswa (untuk chart demografi)
            filteredStudents = filteredStudents.filter(student => {
                const studentKelas = student.KELAS || '';
                // Membandingkan awalan kelas (e.g., 'X' di 'X RPL')
                return studentKelas.startsWith(gradeFilter); 
            });
            
            // Terapkan filter ke daftar absensi (untuk chart persentase)
            filteredAttendance = filteredAttendance.filter(record => {
                const recordKelas = record.KELAS || '';
                return recordKelas.startsWith(gradeFilter);
            });
        }
        // --- END NEW FIX ---


        // --- Agregasi Data Demografi (Jumlah Siswa) ---
        const classDemographic = {};
        const majorDemographic = {};

        filteredStudents.forEach(student => {
            const kelas = student.KELAS || 'N/A';
            const jurusan = student.JURUSAN || 'N/A';
            
            if (kelas !== 'N/A') {
                classDemographic[kelas] = (classDemographic[kelas] || 0) + 1;
            }
            if (jurusan !== 'N/A') {
                majorDemographic[jurusan] = (majorDemographic[jurusan] || 0) + 1;
            }
        });

        const classComparisonDemographic = Object.keys(classDemographic).map(key => ({ label: key, value: classDemographic[key] }));
        const majorComparisonDemographic = Object.keys(majorDemographic).map(key => ({ label: key, value: majorDemographic[key] }));


        // --- Agregasi Data Kehadiran (Hitungan Status) ---
        // Menggunakan data absensi dari 3 bulan terakhir untuk relevansi (default)
        const dateRangeParams = { periode: '3bulan' };
        const { startDate: threeMonthStart, endDate: todayFormatted } = getFilterDates(dateRangeParams);
        
        // Terapkan filter tanggal pada data absensi yang sudah difilter (wewenang + grade level)
        const recentAttendance = filterAttendanceByDateRange(filteredAttendance, threeMonthStart, todayFormatted);


        const attendanceCountByClass = {};
        const attendanceCountByMajor = {};

        recentAttendance.forEach(row => {
            const status = row.STATUS || 'Alpha'; 
            const kelas = row.KELAS || 'N/A';
            const jurusan = row.JURUSAN || 'N/A';
            
            if (kelas !== 'N/A') {
                if (!attendanceCountByClass[kelas]) {
                    attendanceCountByClass[kelas] = { Hadir: 0, Izin: 0, Sakit: 0, Alpha: 0, Total: 0 };
                }
                attendanceCountByClass[kelas][status] = (attendanceCountByClass[kelas][status] || 0) + 1;
                attendanceCountByClass[kelas].Total += 1;
            }

            if (jurusan !== 'N/A') {
                if (!attendanceCountByMajor[jurusan]) {
                    attendanceCountByMajor[jurusan] = { Hadir: 0, Izin: 0, Sakit: 0, Alpha: 0, Total: 0 };
                }
                attendanceCountByMajor[jurusan][status] = (attendanceCountByMajor[jurusan][status] || 0) + 1;
                attendanceCountByMajor[jurusan].Total += 1;
            }
        });

        // --- Hitung Persentase Kehadiran ---
        const calculatePercentage = (data) => {
            const result = {};
            for (const key in data) {
                const total = data[key].Total;
                if (total > 0) {
                    result[key] = {
                        Hadir: ((data[key].Hadir / total) * 100).toFixed(1),
                        Izin: ((data[key].Izin / total) * 100).toFixed(1),
                        Sakit: ((data[key].Sakit / total) * 100).toFixed(1),
                        Alpha: ((data[key].Alpha / total) * 100).toFixed(1),
                        TotalRecords: total
                    };
                } else {
                    result[key] = { Hadir: 0, Izin: 0, Sakit: 0, Alpha: 0, TotalRecords: 0 };
                }
            }
            return result;
        };

        const classComparisonAttendance = calculatePercentage(attendanceCountByClass);
        const majorComparisonAttendance = calculatePercentage(attendanceCountByMajor);
        
        // Pilih data demografi dan kehadiran berdasarkan filterType yang diminta
        const finalDemographic = (filterType === 'class') ? classComparisonDemographic : majorComparisonDemographic;
        const finalAttendance = (filterType === 'class') ? classComparisonAttendance : majorComparisonAttendance;
        

        return createJsonResponse({ 
            status: 'success', 
            demographic: finalDemographic,
            attendance_percent: finalAttendance,
        });

    } catch (e) {
        Logger.log(`Error getComparisonData: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat mengambil data perbandingan: ${e.message}` });
    }
}


// --- ADMIN MANAGEMENT FUNCTION (getAllStudents) ---

/**
 * Mengambil semua data siswa dari sheet DATA SISWA (untuk Admin).
 */
function getAllStudents() {
    try {
        const { data: studentData } = getSheetData(STUDENT_SHEET_NAME);
        
        const students = studentData.map(row => ({
            nisn: row['NISN'] || '-',
            nama: row['NAMA LENGKAP'] || 'Nama Kosong',
            kelas: row['KELAS'] || '-',
            jurusan: row['JURUSAN'] || '-',
            email: row['EMAIL'] || '-',
            password: row['PASSWORD'] || '' // Kosongkan password untuk keamanan, hanya tampilkan yang sudah di-set
        }));
        
        return createJsonResponse({ status: 'success', students: students });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat memuat semua siswa: ${e.message}` });
    }
}

/**
 * NEW: Menangani penambahan siswa baru.
 */
function addStudent(params) {
    try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(STUDENT_SHEET_NAME);

        if (!sheet) {
            throw new Error(`Sheet data siswa (${STUDENT_SHEET_NAME}) tidak ditemukan.`);
        }

        const { headers, data } = getSheetData(STUDENT_SHEET_NAME);
        
        // Cek duplikasi NISN
        const isDuplicate = data.some(row => row['NISN'] && row['NISN'].toString().trim() === params.nisn.toString().trim());
        if (isDuplicate) {
             return createJsonResponse({ status: 'error', message: `Gagal: NISN ${params.nisn} sudah terdaftar.` });
        }

        // Temukan indeks header untuk memastikan urutan data benar saat append
        const headerMap = {
            'NISN': params.nisn, 
            'NAMA LENGKAP': params.nama,
            'KELAS': params.kelas, 
            'JURUSAN': params.jurusan, 
            'EMAIL': params.email,
            'PASSWORD': params.password
        };

        const finalRow = headers.map(header => headerMap[header] || '');

        sheet.appendRow(finalRow);

        return createJsonResponse({ status: 'success', message: 'Data siswa baru berhasil ditambahkan.' });

    } catch (e) {
        Logger.log(`Error addStudent: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat menambah siswa: ${e.message}` });
    }
}

/**
 * NEW: Menangani penghapusan siswa tunggal.
 */
function deleteStudent(params) {
    try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(STUDENT_SHEET_NAME);
        const nisnToDelete = params.nisn.toString().trim();

        if (!sheet) {
            throw new Error(`Sheet data siswa (${STUDENT_SHEET_NAME}) tidak ditemukan.`);
        }

        const allDataRange = sheet.getDataRange();
        const headers = allDataRange.getValues()[0].map(h => h.toString().trim().toUpperCase());
        const dataValues = allDataRange.getValues();
        const studentData = dataValues.slice(1);
        const nisnIndex = headers.indexOf('NISN');

        if (nisnIndex === -1) {
            throw new Error('Kolom wajib (NISN) tidak ditemukan di Sheet DATA SISWA.');
        }

        // Cari baris yang cocok (mulai dari baris ke-2 / index 1)
        for (let i = studentData.length - 1; i >= 0; i--) {
            if (studentData[i][nisnIndex].toString().trim() === nisnToDelete) {
                // Hapus baris (i + 2 karena baris data mulai dari baris ke-2)
                sheet.deleteRow(i + 2);
                return createJsonResponse({ status: 'success', message: `Siswa NISN ${nisnToDelete} berhasil dihapus.` });
            }
        }

        return createJsonResponse({ status: 'error', message: `Siswa dengan NISN ${nisnToDelete} tidak ditemukan.` });

    } catch (e) {
        Logger.log(`Error deleteStudent: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat menghapus siswa: ${e.message}` });
    }
}


/**
 * NEW: Menangani penghapusan siswa berdasarkan filter (Perbaikan yang diminta).
 */
function deleteStudentsByFilter(params) {
    const { searchTerm, kelas, jurusan } = params;
    
    try {
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(STUDENT_SHEET_NAME);

        if (!sheet) {
            throw new Error(`Sheet data siswa (${STUDENT_SHEET_NAME}) tidak ditemukan.`);
        }

        const allDataRange = sheet.getDataRange();
        const dataValues = allDataRange.getValues();
        const headers = dataValues[0].map(h => h.toString().trim().toUpperCase());
        
        const nisnIndex = headers.indexOf('NISN');
        const namaIndex = headers.indexOf('NAMA LENGKAP');
        const kelasIndex = headers.indexOf('KELAS');
        const jurusanIndex = headers.indexOf('JURUSAN');

        if (nisnIndex === -1 || namaIndex === -1 || kelasIndex === -1 || jurusanIndex === -1) {
            throw new Error('Kolom wajib (NISN, NAMA LENGKAP, KELAS, JURUSAN) tidak ditemukan di Sheet DATA SISWA.');
        }

        let deletedCount = 0;
        const studentData = dataValues.slice(1);
        
        // Loop mundur untuk menghapus baris agar indeks tidak bergeser
        for (let i = studentData.length - 1; i >= 0; i--) {
            const row = studentData[i];
            const rowNisn = row[nisnIndex].toString().trim();
            const rowNama = row[namaIndex].toString().trim().toLowerCase();
            const rowKelas = row[kelasIndex].toString().trim();
            const rowJurusan = row[jurusanIndex].toString().trim();
            
            let matchesSearch = true;
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                matchesSearch = rowNama.includes(searchLower) || rowNisn.includes(searchLower);
            }
            
            const matchesKelas = !kelas || rowKelas === kelas;
            const matchesJurusan = !jurusan || rowJurusan === jurusan;

            // Jika baris cocok dengan semua kriteria filter
            if (matchesSearch && matchesKelas && matchesJurusan) {
                // Hapus baris. Baris di sheet = index data + 2 (header + 1-based index)
                sheet.deleteRow(i + 2);
                deletedCount++;
            }
        }

        if (deletedCount === 0) {
            return createJsonResponse({ status: 'error', message: 'Tidak ada baris siswa yang cocok dengan kriteria filter untuk dihapus.' });
        }

        return createJsonResponse({ status: 'success', message: `${deletedCount} siswa telah dihapus berdasarkan filter.` });

    } catch (e) {
        Logger.log(`Error deleteStudentsByFilter: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat menghapus siswa berdasarkan filter: ${e.message}` });
    }
}


/**
 * NEW: Menangani update data siswa massal dari Admin Management.
 */
function updateStudentDataBatch(params) {
    try {
        const updates = JSON.parse(params.updates);
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(STUDENT_SHEET_NAME);
        
        if (!sheet) {
            throw new Error(`Sheet data siswa (${STUDENT_SHEET_NAME}) tidak ditemukan.`);
        }

        const allDataRange = sheet.getDataRange();
        const headers = allDataRange.getValues()[0].map(h => h.toString().trim().toUpperCase());
        const dataValues = allDataRange.getValues();
        const studentData = dataValues.slice(1);

        const nisnIndex = headers.indexOf('NISN');
        const namaIndex = headers.indexOf('NAMA LENGKAP');
        const kelasIndex = headers.indexOf('KELAS');
        const jurusanIndex = headers.indexOf('JURUSAN');
        const emailIndex = headers.indexOf('EMAIL');
        const passwordIndex = headers.indexOf('PASSWORD');

        if (nisnIndex === -1 || namaIndex === -1 || kelasIndex === -1 || jurusanIndex === -1 || emailIndex === -1) {
            throw new Error('Kolom wajib (NISN, NAMA LENGKAP, KELAS, JURUSAN, EMAIL) tidak ditemukan di Sheet DATA SISWA.');
        }

        let changesMade = 0;

        updates.forEach(update => {
            const rowIndexInSheet = studentData.findIndex(row => row[nisnIndex].toString().trim() === update.nisn.toString().trim());

            if (rowIndexInSheet !== -1) {
                const sheetRowIndex = rowIndexInSheet + 2; // +1 for header, +1 for 0-index offset

                // Get the actual row to update
                const rowToUpdate = dataValues[sheetRowIndex - 1]; 

                // Update fields
                rowToUpdate[namaIndex] = update.nama;
                rowToUpdate[kelasIndex] = update.kelas;
                rowToUpdate[jurusanIndex] = update.jurusan;
                rowToUpdate[emailIndex] = update.email;
                if (passwordIndex !== -1 && update.password) {
                    rowToUpdate[passwordIndex] = update.password;
                }

                // Apply changes to the spreadsheet
                sheet.getRange(sheetRowIndex, 1, 1, rowToUpdate.length).setValues([rowToUpdate]);
                changesMade++;
            }
        });

        if (changesMade === 0) {
            return createJsonResponse({ status: 'error', message: 'Tidak ada baris siswa yang ditemukan atau diubah.' });
        }

        return createJsonResponse({ status: 'success', message: `Berhasil memperbarui ${changesMade} data siswa.` });

    } catch (e) {
        Logger.log(`Error updateStudentDataBatch: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat memperbarui data siswa: ${e.message}` });
    }
}


// --- MANUAL ATTENDANCE FUNCTIONS ---

function getStudentListWithStatus(params) {
    const { kelas, jurusan, date } = params;
    
    try {
        const { data: studentData } = getSheetData(STUDENT_SHEET_NAME);
        const { data: attendanceData } = getSheetData(ATTENDANCE_SHEET_NAME);
        
        let filteredStudents = studentData.filter(row => 
            row['KELAS'] && row['KELAS'].toString().trim() === kelas.toString().trim() &&
            row['JURUSAN'] && row['JURUSAN'].toString().trim() === jurusan.toString().trim()
        );
        
        filteredStudents.sort((a, b) => a['NAMA LENGKAP'].localeCompare(b['NAMA LENGKAP'])); // Sortir berdasarkan Nama

        const studentsWithStatus = filteredStudents.map(student => {
            const nisn = student['NISN'].toString().trim();
            
            const currentRecord = attendanceData.find(record =>
                record['NISN'] && record['NISN'].toString().trim() === nisn &&
                record['DATE'] && record['DATE'].toString().trim() === date
            );
            
            return {
                nisn: nisn,
                nama: student['NAMA LENGKAP'],
                status: currentRecord ? currentRecord['STATUS'] : 'Alpha', 
                keterangan: currentRecord ? currentRecord['KETERANGAN'] : '-'
            };
        });
        
        return createJsonResponse({ status: 'success', students: studentsWithStatus });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat memuat daftar siswa: ${e.message}` });
    }
}

function handleManualAttendanceUpdate(params) {
    try {
        const updates = JSON.parse(params.updates);
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        const sheet = ss.getSheetByName(ATTENDANCE_SHEET_NAME);
        
        const allDataRange = sheet.getDataRange();
        const headers = allDataRange.getValues()[0].map(h => h.toString().trim().toUpperCase());
        
        const dateIndex = headers.indexOf('DATE') + 1;
        const nisnIndex = headers.indexOf('NISN') + 1;
        const namaIndex = headers.indexOf('NAMA LENGKAP') + 1; // Index nama
        const kelasIndex = headers.indexOf('KELAS') + 1; // Index kelas
        const jurusanIndex = headers.indexOf('JURUSAN') + 1; // Index jurusan
        const statusIndex = headers.indexOf('STATUS') + 1;
        const keteranganIndex = headers.indexOf('KETERANGAN') + 1;
        const timeIndex = headers.indexOf('TIME') + 1;
        const submitByIndex = headers.indexOf('SUBMITTED BY') + 1;

        if (dateIndex === 0 || nisnIndex === 0 || statusIndex === 0 || submitByIndex === 0 || namaIndex === 0 || kelasIndex === 0 || jurusanIndex === 0) {
            throw new Error('Kolom wajib (DATE, NISN, NAMA LENGKAP, KELAS, JURUSAN, STATUS, SUBMITTED BY) tidak ditemukan di Sheet Absensi.');
        }

        const lastRow = sheet.getLastRow();
        let existingData = [];
        if (lastRow > 1) {
             existingData = sheet.getRange(2, 1, lastRow - 1, headers.length).getValues();
        }
        
        let rowsToUpdate = [];
        let rowsToAdd = [];
        const spreadsheetTimeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
        const currentTime = Utilities.formatDate(new Date(), spreadsheetTimeZone, 'HH:mm:ss');
        
        updates.forEach(update => {
            let found = false;
            for (let i = 0; i < existingData.length; i++) {
                const row = existingData[i];
                
                const rowDateStr = (row[dateIndex - 1] instanceof Date) 
                    ? Utilities.formatDate(row[dateIndex - 1], spreadsheetTimeZone, 'yyyy-MM-dd') 
                    : row[dateIndex - 1].toString().trim();

                if (row[nisnIndex - 1].toString().trim() === update.nisn.toString().trim() && 
                    rowDateStr === update.date) {
                    
                    row[statusIndex - 1] = update.status;
                    row[keteranganIndex - 1] = update.keterangan;
                    
                    // Logic update Time: Isi jika Hadir, Kosongkan jika Tidak Hadir
                    if (timeIndex > 0) {
                        const isTimeEmpty = !row[timeIndex - 1] || row[timeIndex - 1].toString().trim() === '';
                        if (update.status === 'Hadir') {
                            // Hanya isi jika Hadir DAN waktu belum ada
                            if (isTimeEmpty) { 
                                row[timeIndex - 1] = currentTime;
                            }
                        } else {
                            // Kosongkan jika tidak hadir
                            row[timeIndex - 1] = ''; 
                        }
                    }
                    
                    row[submitByIndex - 1] = params.submittedBy;
                    rowsToUpdate.push({ rowIndex: i + 2, data: row });
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                const newRowData = new Array(headers.length).fill('');
                
                newRowData[dateIndex - 1] = update.date;
                newRowData[nisnIndex - 1] = update.nisn;
                newRowData[namaIndex - 1] = update.nama;
                newRowData[kelasIndex - 1] = update.kelas;
                newRowData[jurusanIndex - 1] = update.jurusan;
                newRowData[statusIndex - 1] = update.status;
                newRowData[keteranganIndex - 1] = update.keterangan;
                newRowData[submitByIndex - 1] = params.submittedBy;

                if (timeIndex > 0 && update.status === 'Hadir') {
                    newRowData[timeIndex - 1] = currentTime;
                }
                
                rowsToAdd.push(newRowData);
            }
        });

        rowsToUpdate.forEach(item => {
            sheet.getRange(item.rowIndex, 1, 1, item.data.length).setValues([item.data]);
        });

        if (rowsToAdd.length > 0) {
            sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAdd.length, headers.length).setValues(rowsToAdd);
        }

        return createJsonResponse({ status: 'success', message: 'Pembaruan absensi massal berhasil.' });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat memperbarui absensi: ${e.message}. Pastikan semua kolom yang diperlukan ada.` });
    }
}


// --- ASSESSMENT FUNCTIONS ---

function getAssessmentList(params) {
    const { kelas, jurusan, type, date } = params;
    
    try {
        const { data: studentData } = getSheetData(STUDENT_SHEET_NAME);
        
        let students = studentData.filter(row => 
            row['KELAS'] && row['KELAS'].toString().trim() === kelas.toString().trim() &&
            row['JURUSAN'] && row['JURUSAN'].toString().trim() === jurusan.toString().trim()
        );

        if (type === 'harian') {
            const { data: harianData } = getSheetData(ASSESSMENT_HARIAN_SHEET_NAME);
            
            students = students.map(student => {
                const nisn = student['NISN'].toString().trim();
                const record = harianData.find(row => 
                    row['NISN'] && row['NISN'].toString().trim() === nisn &&
                    row['TANGGAL'] && row['TANGGAL'].toString().trim() === date
                );
                return {
                    nisn: nisn, nama: student['NAMA LENGKAP'],
                    scoreHarian: record ? (record['NILAI'] || '') : ''
                };
            });
            
        } else if (type === 'pts' || type === 'pas') {
            const { data: finalData } = getSheetData(ASSESSMENT_FINAL_SHEET_NAME);
            const scoreCol = (type === 'pts') ? 'NILAI PTS' : 'NILAI PAS';
            
            students = students.map(student => {
                const nisn = student['NISN'].toString().trim();
                const record = finalData.find(row => 
                    row['NISN'] && row['NISN'].toString().trim() === nisn
                );
                return {
                    nisn: nisn, nama: student['NAMA LENGKAP'],
                    scoreFinal: record ? (record[scoreCol] || '') : ''
                };
            });
        }
        
        return createJsonResponse({ status: 'success', students: students });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat memuat daftar penilaian: ${e.message}` });
    }
}

/**
 * Menangani pembaruan atau penambahan nilai massal.
 */
function saveAssessmentBatch(params) {
    try {
        const updates = JSON.parse(params.updates);
        const { type, date, submittedBy } = params;
        const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
        
        const isHarian = (type === 'harian');
        const sheetName = isHarian ? ASSESSMENT_HARIAN_SHEET_NAME : ASSESSMENT_FINAL_SHEET_NAME;
        const sheet = ss.getSheetByName(sheetName);
        
        if (!sheet) {
            throw new Error(`Sheet penilaian (${sheetName}) tidak ditemukan.`);
        }

        const allDataRange = sheet.getDataRange();
        const headers = allDataRange.getValues()[0].map(h => h.toString().trim().toUpperCase());
        const dataValues = allDataRange.getValues();
        const existingData = dataValues.slice(1);
        
        const nisnIndex = headers.indexOf('NISN');
        const scoreHeader = isHarian ? 'NILAI' : (type === 'pts' ? 'NILAI PTS' : 'NILAI PAS');
        const scoreIndex = headers.indexOf(scoreHeader);
        const dateIndex = headers.indexOf(isHarian ? 'TANGGAL' : 'DATE'); 
        
        const nameIndex = headers.indexOf('NAMA LENGKAP');
        
        if (nisnIndex === -1 || scoreIndex === -1) {
            throw new Error(`Kolom wajib (NISN atau ${scoreHeader}) tidak ditemukan di sheet ${sheetName}.`);
        }
        if (isHarian && dateIndex === -1) {
            throw new Error(`Kolom wajib TANGGAL tidak ditemukan di sheet ${sheetName}.`);
        }

        let rowsToUpdate = [];
        let rowsToAdd = [];

        updates.forEach(update => {
            const nisn = update.nisn.toString().trim();
            let found = false;
            
            for (let i = 0; i < existingData.length; i++) {
                const row = existingData[i];
                
                // Logic untuk NILAI HARIAN: Cocokkan NISN DAN Tanggal
                if (isHarian) {
                    const rowDate = row[dateIndex];
                    const rowNisn = row[nisnIndex].toString().trim();
                    
                    if (rowNisn === nisn && rowDate === date) {
                        row[scoreIndex] = update.score; // Update Nilai
                        // Update Baris di Sheet Asli
                        rowsToUpdate.push({ rowIndex: i + 2, data: row });
                        found = true;
                        break;
                    }
                } 
                // Logic untuk PTS/PAS: Cocokkan hanya NISN (karena ini nilai final)
                else {
                    if (row[nisnIndex].toString().trim() === nisn) {
                        row[scoreIndex] = update.score; // Update Nilai
                        rowsToUpdate.push({ rowIndex: i + 2, data: row });
                        found = true;
                        break;
                    }
                }
            }
            
            // Jika tidak ditemukan (Hanya untuk Nilai Harian atau jika data master PTS/PAS kosong)
            if (!found) {
                const newRowData = new Array(headers.length).fill('');
                
                // Isi field yang pasti ada
                newRowData[nisnIndex] = nisn;
                newRowData[scoreIndex] = update.score;
                
                // Isi field tambahan jika Harian
                if (isHarian) {
                    newRowData[dateIndex] = date;
                    if (nameIndex > -1) newRowData[nameIndex] = update.nama;
                } else {
                    // Isi field tambahan untuk PTS/PAS jika kolomnya ada (Nama, Kelas, Jurusan, dll)
                    if (nameIndex > -1) newRowData[nameIndex] = update.nama;
                }
                
                rowsToAdd.push(newRowData);
            }
        });
        
        // 1. Lakukan update pada baris yang sudah ada
        rowsToUpdate.forEach(item => {
            sheet.getRange(item.rowIndex, 1, 1, item.data.length).setValues([item.data]);
        });

        // 2. Tambahkan baris baru
        if (rowsToAdd.length > 0) {
            sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAdd.length, headers.length).setValues(rowsToAdd);
        }
        
        return createJsonResponse({ status: 'success', message: 'Pembaruan nilai berhasil.' });

    } catch (e) {
        Logger.log(`Error saveAssessmentBatch: ${e.message}`);
        return createJsonResponse({ status: 'error', message: `Error Server saat menyimpan penilaian: ${e.message}.` });
    }
}

/**
 * NEW FUNCTION: Untuk menyimpan konfigurasi aplikasi.
 */
function saveAppConfiguration(params) {
    try {
        const { schoolName, logoUrl } = params;
        
        // Anda dapat memilih untuk menyimpan konfigurasi ini di sheet terpisah 
        // atau langsung di User Properties (lebih sederhana untuk data kecil).
        
        const properties = PropertiesService.getUserProperties();
        properties.setProperty('SCHOOL_NAME', schoolName);
        properties.setProperty('LOGO_URL', logoUrl);
        
        return createJsonResponse({ status: 'success', message: 'Konfigurasi aplikasi berhasil disimpan.' });

    } catch (e) {
        return createJsonResponse({ status: 'error', message: `Error Server saat menyimpan konfigurasi: ${e.message}` });
    }
}
